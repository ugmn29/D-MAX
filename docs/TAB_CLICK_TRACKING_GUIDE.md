# HPタブクリック詳細トラッキング 完全ガイド

## 📊 概要

HPに複数の予約ボタン（タブ）がある場合、**どのタブから最も予約に繋がっているか**を詳細に分析できます。

### 測定できる情報

| 指標 | 説明 |
|------|------|
| **タブ別クリック数** | 各タブが何回クリックされたか |
| **予約ページ到達率** | クリック後、予約ページに到達した割合 |
| **予約完了率** | クリックから予約完了までのコンバージョン率 |
| **流入元×タブのクロス分析** | Google広告経由のユーザーがどのタブをクリックしたか |
| **デバイス別分析** | PC/mobile/tabletごとのタブクリック傾向 |

### 他ツールとの連携

- **Microsoft Clarity**: ヒートマップでタブの位置を視覚的に確認
- **Google Tag Manager**: GA4やGoogle Adsにイベント送信
- **D-MAX独自DB**: タブ別の予約完了率を数値で分析

---

## 🚀 セットアップ手順

### Step 1: データベースマイグレーション

```bash
cd /Users/fukunagashindai/Downloads/D-MAX
npx supabase db push
```

これで以下のテーブルが追加されます:
- `hp_tab_click_events` - タブクリックイベント記録
- `patient_acquisition_sources` にタブ情報カラム追加
- `web_booking_funnel_events` にタブ情報カラム追加

### Step 2: トラッキングスクリプトの取得

1. D-MAXにログイン
2. **分析 → Web予約効果 → タブスクリプト** タブを開く
3. 「Step 1」のスクリプトをコピー
4. クライアントのHPの `</body>` 直前に埋め込む

### Step 3: 予約ボタンにdata属性を追加

各予約ボタンに以下の属性を追加します:

```html
<!-- 例1: ヘッダーの予約ボタン -->
<a href="予約ページURL"
   data-dmax-tab="header_button"
   data-dmax-position="header"
   class="booking-button">
  予約する
</a>

<!-- 例2: サイドバーの予約ボタン -->
<a href="予約ページURL"
   data-dmax-tab="sidebar_button"
   data-dmax-position="sidebar"
   class="booking-button">
  今すぐ予約
</a>

<!-- 例3: フッターの予約ボタン -->
<a href="予約ページURL"
   data-dmax-tab="footer_button"
   data-dmax-position="footer"
   class="booking-button">
  Web予約はこちら
</a>
```

**属性の説明:**
- `data-dmax-tab`: タブの識別ID（自由に設定）
- `data-dmax-position`: タブの位置（header, sidebar, footer, content, floating）

---

## 📈 分析方法

### タブ分析画面で確認

```
D-MAX > 分析 > Web予約効果 > タブ分析
```

#### 確認できる指標

1. **総タブクリック数** - HP全体で予約ボタンが何回クリックされたか
2. **予約完了数** - タブクリック経由の予約完了数
3. **全体コンバージョン率** - タブクリックから予約完了までの率

#### タブ別統計

| タブ | クリック数 | 予約ページ到達 | 予約完了 | 完了率 |
|------|----------|----------------|----------|--------|
| ヘッダーボタン | 150回 | 120回 (80%) | 45件 (30%) | 30% |
| サイドバーボタン | 80回 | 50回 (62.5%) | 15件 (18.8%) | 18.8% |
| フッターボタン | 50回 | 30回 (60%) | 8件 (16%) | 16% |

### 流入元×タブのクロス分析

どの流入元から来たユーザーが、どのタブをクリックしているかを確認:

| タブ | 流入元 | クリック数 | 予約数 | 完了率 |
|------|--------|----------|--------|--------|
| ヘッダーボタン | Google広告 | 80 | 30 | 37.5% |
| ヘッダーボタン | Instagram広告 | 50 | 12 | 24% |
| サイドバーボタン | Google広告 | 30 | 8 | 26.7% |

**分析例:**
- Google広告経由のユーザーはヘッダーボタンをよくクリックする
- Instagram広告経由のユーザーはサイドバーボタンをクリックする傾向

---

## 🎯 活用例

### ケース1: 効果の低いタブを特定

```
タブ分析で発覚:
- ヘッダーボタン: 完了率 30%
- サイドバーボタン: 完了率 18%
- フッターボタン: 完了率 16%

対策:
→ サイドバーとフッターのデザイン・文言を改善
→ Clarityでユーザー行動を録画確認
```

### ケース2: デバイス別の最適化

```
分析結果:
- PC: ヘッダーボタンからの予約が多い
- Mobile: フローティングCTAからの予約が多い

対策:
→ PCではヘッダーを強調
→ Mobileではフローティングボタンを大きく
```

### ケース3: 広告別の最適化

```
分析結果:
- Google広告: ヘッダーボタンで完了率 35%
- Instagram広告: サイドバーボタンで完了率 25%

対策:
→ Google広告のLP: ヘッダーボタンを強調
→ Instagram広告のLP: サイドバーを改善
```

---

## 🔍 Clarityとの連携

### Clarityで視覚的に確認

1. [clarity.microsoft.com](https://clarity.microsoft.com/) にアクセス
2. プロジェクトを選択
3. **Heatmaps** → HPのURLを選択
4. **Click Heatmap** でタブのクリック密度を確認

### フィルタリング

Clarityのカスタムタグでフィルタリング可能:
```
clicked_tab = header_button
```

これで「ヘッダーボタンをクリックしたユーザー」のセッションだけを抽出し、録画で確認できます。

---

## 📊 GTM連携（応用）

### GA4にイベント送信

GTMで以下の設定を追加すると、GA4でもタブ分析可能:

#### 1. カスタムイベントトリガー

```
トリガータイプ: カスタムイベント
イベント名: tab_click
```

#### 2. GA4イベントタグ

```
タグの種類: Google アナリティクス: GA4 イベント
イベント名: tab_click
イベントパラメータ:
  - tab_id: {{Data Layer Variable - tab_id}}
  - tab_label: {{Data Layer Variable - tab_label}}
  - tab_position: {{Data Layer Variable - tab_position}}
```

これで GA4 の「エンゲージメント」→「イベント」でタブクリックを確認できます。

---

## 🎨 推奨タブID命名規則

統一感のある命名でデータを整理しやすくします:

### 位置別

| タブID | 説明 |
|--------|------|
| `header_button` | ヘッダーの予約ボタン |
| `sidebar_button` | サイドバーの予約ボタン |
| `footer_button` | フッターの予約ボタン |
| `floating_cta` | フローティングCTA |
| `top_hero_button` | トップページのヒーロー画像内ボタン |

### ページ別

| タブID | 説明 |
|--------|------|
| `top_page_cta` | トップページのCTA |
| `price_page_button` | 料金ページの予約ボタン |
| `staff_page_button` | スタッフ紹介ページの予約ボタン |
| `access_page_button` | アクセスページの予約ボタン |
| `treatment_page_button` | 診療内容ページの予約ボタン |

---

## ⚠️ トラブルシューティング

### データが表示されない

1. **ブラウザのコンソールを確認**
   - F12 → Console
   - 「Tab tracking...」というログが表示されるか確認

2. **data属性の確認**
   - `data-dmax-tab` 属性が正しく設定されているか
   - スペルミスがないか

3. **スクリプトの確認**
   - `</body>` 直前に埋め込まれているか
   - クリニックIDが正しいか

### タブクリックは記録されるが予約完了が記録されない

- Web予約ページで予約完了時に `PATCH /api/tracking/tab-click` が呼ばれているか確認
- セッションIDが引き継がれているか確認

---

## 📤 CSVエクスポート

タブ分析画面で「CSVエクスポート」ボタンをクリックすると、以下の形式でダウンロードできます:

```csv
タブID,タブ名,位置,クリック数,予約ページ到達数,予約完了数,到達率(%),予約完了率(%)
header_button,予約する,header,150,120,45,80.0,30.0
sidebar_button,今すぐ予約,sidebar,80,50,15,62.5,18.8
footer_button,Web予約はこちら,footer,50,30,8,60.0,16.0
```

Excelで開いて、グラフ化・ピボットテーブル作成が可能です。

---

## 🎉 完成！

これで、HPのどのタブから最も予約に繋がっているかを詳細に分析できます。

**取得できるデータ:**
- ✅ タブ別のクリック数
- ✅ タブ別の予約完了率
- ✅ 流入元×タブのクロス分析
- ✅ デバイス別のタブクリック傾向
- ✅ Clarityでの視覚的確認
- ✅ GA4での詳細分析

**定期的な改善サイクル:**
1. タブ分析でデータ確認（週1回）
2. 効果の低いタブを特定
3. Clarityで録画確認
4. デザイン・文言を改善
5. 1週間後に効果測定

これを繰り返すことで、予約完了率を継続的に改善できます！
