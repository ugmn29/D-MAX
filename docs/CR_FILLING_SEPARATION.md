# CR充填の3分離実装ドキュメント

## 概要

CR充填（コンポジットレジン充填）を、厚生労働省の歯科保険点数表に基づき、**形成料・充填料・材料代の3つに正しく分離**しました。

## 背景

従来のシステムでは、CR充填が単一の項目として扱われていましたが、実際の保険点数表では以下のように分離されています：

1. **形成料**（M001-3 窩洞形成）
2. **充填料**（M009 充填）
3. **材料代**（M100 特定保険医療材料）

これにより、正確な保険請求と適切な点数計算が可能になります。

## 実装内容

### 1. データベースマイグレーション

**ファイル**: `supabase/migrations/20251113_cr_filling_separation.sql`

#### 1.1 形成料（M001-3 窩洞形成）

| コード | 名称 | 点数 | PDF参照 |
|--------|------|------|---------|
| 140000310 | 窩洞形成（単純なもの） | 60点 | Page 68, M001-3-イ |
| 140000410 | 窩洞形成（複雑なもの） | 86点 | Page 68, M001-3-ロ |

**備考**: 麻酔、薬剤等の費用及び保険医療材料料は所定点数に含まれる

#### 1.2 充填料（M009 充填）

| コード | 名称 | 点数 | PDF参照 | 備考 |
|--------|------|------|---------|------|
| 140009110 | 充填１（単純なもの） | 106点 | Page 71, M009-1-イ | 歯面処理あり（CR充填） |
| 140009210 | 充填１（複雑なもの） | 158点 | Page 71, M009-1-ロ | 歯面処理あり（CR充填） |
| 140009310 | 充填２（単純なもの） | 59点 | Page 71, M009-2-イ | 歯面処理なし |
| 140009410 | 充填２（複雑なもの） | 107点 | Page 71, M009-2-ロ | 歯面処理なし |

**充填１と充填２の違い**:
- **充填１**: 歯質に対する接着性を付与又は向上させるために歯面処理を行う場合（CR充填が該当）
- **充填２**: それ以外（歯面処理を行わない場合）

**単純と複雑の区別**:
- **単純なもの**: 隣接面（近心面・遠心面）を含まない窩洞（咬合面のみ、頬側面のみなど）
- **複雑なもの**: 隣接面を含む窩洞（MO、DO、MODなど）

#### 1.3 形成・充填一体（M001-2）

| コード | 名称 | 点数 | PDF参照 | 包括内容 |
|--------|------|------|---------|----------|
| 140000210 | う蝕歯即時充填形成 | 128点 | Page 69, M001-2 | 麻酔、歯髄保護処置、窩洞形成、充填 |

**備考**: 小さいう蝕の場合に、形成と充填を一度に行う場合に使用

#### 1.4 材料代（M100）

材料代は別途、特定保険医療材料料として算定します。

**M100 特定保険医療材料**:
- 材料価格を10円で除して得た点数
- 使用した特定保険医療材料の材料価格は、別に厚生労働大臣が定める

## CR充填の典型的な算定パターン

### パターン1: 単純なCR充填

```
① 窩洞形成（単純なもの）      : 60点
② 充填１（単純なもの）※CR     : 106点
③ 材料代（M100）              : 別途算定
─────────────────────────────────
   合計                       : 166点 + 材料代
```

**適用例**: 小窩裂溝の単純なう蝕

### パターン2: 複雑なCR充填

```
① 窩洞形成（複雑なもの）      : 86点
② 充填１（複雑なもの）※CR     : 158点
③ 材料代（M100）              : 別途算定
─────────────────────────────────
   合計                       : 244点 + 材料代
```

**適用例**: 2面以上にわたる複雑なう蝕

### パターン3: 即時充填形成

```
① う蝕歯即時充填形成          : 128点
   （麻酔、歯髄保護、形成、充填すべて含む）
─────────────────────────────────
   合計                       : 128点
```

**適用例**: 小さいう蝕で、形成と充填を一度に行える場合

## UI/UXの更新

### EMR入力モーダル

**ファイル**: `components/emr/emr-input-modal.tsx`

充填カテゴリーのプリセットを以下のように更新：

```typescript
filling: [
  // 形成料（M001-3）
  { id: 'formation_simple', code: '140000310', name: '窩洞形成（単純なもの）', points: 60 },
  { id: 'formation_complex', code: '140000410', name: '窩洞形成（複雑なもの）', points: 86 },

  // 充填料（M009）
  { id: 'filling_1_simple', code: '140009110', name: '充填１（単純なもの）※CR', points: 106 },
  { id: 'filling_1_complex', code: '140009210', name: '充填１（複雑なもの）※CR', points: 158 },
  { id: 'filling_2_simple', code: '140009310', name: '充填２（単純なもの）', points: 59 },
  { id: 'filling_2_complex', code: '140009410', name: '充填２（複雑なもの）', points: 107 },

  // 形成・充填一体（M001-2）
  { id: 'immediate_filling', code: '140000210', name: 'う蝕歯即時充填形成', points: 128 },
]
```

### 治療セット

**ファイル**: `scripts/seed-treatment-sets.ts`

充填セット（SET_FILLING）を以下のように更新：

```typescript
await addSetItems('SET_FILLING', [
  // 形成料
  { code: '140000310', name: '窩洞形成（単純なもの）', notes: '形成料：60点' },
  { code: '140000410', name: '窩洞形成（複雑なもの）', notes: '形成料：86点' },

  // 充填料（CR充填）
  { code: '140009110', name: '充填１（単純なもの）※CR', notes: 'CR充填料：106点' },
  { code: '140009210', name: '充填１（複雑なもの）※CR', notes: 'CR充填料：158点' },
  { code: '140009310', name: '充填２（単純なもの）', notes: '充填料：59点' },
  { code: '140009410', name: '充填２（複雑なもの）', notes: '充填料：107点' },

  // 形成・充填一体
  { code: '140000210', name: 'う蝕歯即時充填形成', notes: '形成+充填：128点' },

  // 前処置
  { code: '309000110', name: 'う蝕処置', notes: '充填前の処置：18点' }
])
```

## 実行方法

### 1. マイグレーションの実行

```bash
npx tsx scripts/apply-cr-filling-separation.ts
```

### 2. テストの実行

```bash
npx tsx scripts/test-cr-filling-separation.ts
```

### 3. 治療セットの更新（オプション）

```bash
npx tsx scripts/seed-treatment-sets.ts
```

## テスト結果

✅ 形成料（2種類）が正しく登録されている
✅ 充填料（4種類）が正しく登録されている
✅ 形成・充填一体（1種類）が正しく登録されている
✅ 検索機能で「充填」「窩洞形成」が正しく表示される
✅ UI/EMRモーダルで3つの項目が表示される

## 注意事項

### 1. 材料代の別途算定

材料代（M100）は、使用した特定保険医療材料の材料価格に基づいて別途算定する必要があります。これは「別に厚生労働大臣が定める」ため、実装時には材料マスタテーブルを参照してください。

### 2. 既存データとの互換性

古いコードで登録されたCR充填のデータは、`metadata.replaced_by` フィールドに新しいコードへの参照が追加されています。

### 3. 保険ルールの遵守

- 形成料と充填料は基本的に同日に算定します
- 材料代は実際に使用した材料に応じて算定します
- 即時充填形成は、小さいう蝕で形成と充填を一度に行える場合のみ使用できます

## 参考資料

- **PDF**: 厚生局　歯科保険点数.pdf
  - Page 68: M001 歯冠形成（窩洞形成）
  - Page 69: M001-2 う蝕歯即時充填形成
  - Page 71: M009 充填
  - Page 74: M100 特定保険医療材料

- **関連ファイル**:
  - `supabase/migrations/20251113_cr_filling_separation.sql`
  - `scripts/apply-cr-filling-separation.ts`
  - `scripts/test-cr-filling-separation.ts`
  - `components/emr/emr-input-modal.tsx`
  - `scripts/seed-treatment-sets.ts`

## まとめ

CR充填を形成料・充填料・材料代の3つに正しく分離することで、以下のメリットが得られます：

1. ✅ **正確な保険請求**: 保険点数表に基づく正確な算定
2. ✅ **適切な点数計算**: 各項目の点数を個別に管理
3. ✅ **柔軟な対応**: 単純/複雑、歯面処理の有無などに応じた選択
4. ✅ **監査対応**: レセプト審査に対応した詳細な記録

この実装により、歯科電子カルテシステムとしての信頼性と正確性が向上しました。
