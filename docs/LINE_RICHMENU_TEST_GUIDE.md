# LINEリッチメニュー 動作テストガイド

## 📋 概要

このガイドでは、LINEリッチメニューの各ボタンが正しく動作するかをテストする手順を説明します。

**前提条件**:
- ✅ LINE Developers Console設定完了
- ✅ チャネルアクセストークン取得済み
- ✅ 5つのLIFF ID取得済み
- ✅ D-MAX設定画面で全て入力済み
- ✅ リッチメニュー作成済み

---

## 🎯 テスト対象ボタン

| ボタン | 動作タイプ | 遷移先 |
|--------|----------|--------|
| **Webサイト** | URL遷移 | 医院のWebサイト |
| **家族登録** | LIFF URL | `/liff/family-register` |
| **QRコード** | LIFF URL | `/liff/qr-code` |
| **予約確認** | LIFF URL | `/liff/appointments` |
| **予約を取る** | LIFF URL | `/liff/web-booking` |
| **お問い合わせ** | メッセージ送信 | "CONTACT_REQUEST"を送信 |

---

## 🚀 事前準備

### 1. 開発サーバー起動

```bash
cd /Users/fukunagashindai/Downloads/D-MAX
npm run dev
```

サーバーが起動したら: `http://localhost:3000`

### 2. ngrokでHTTPSトンネル作成

LIFFはHTTPS必須のため、ngrokを使用します：

```bash
# ngrokインストール（未インストールの場合）
brew install ngrok

# ngrok起動
ngrok http 3000
```

表示されるHTTPS URL（例: `https://abc123.ngrok.io`）をメモしてください。

### 3. LIFF Endpoint URLを更新

LINE Developers Console > LIFF > 各LIFFアプリの設定

**5つ全てのLIFFアプリで以下を更新**:

| LIFF名 | Endpoint URL |
|--------|-------------|
| 初回連携 | `https://abc123.ngrok.io/liff/initial-link` |
| QRコード | `https://abc123.ngrok.io/liff/qr-code` |
| 家族登録 | `https://abc123.ngrok.io/liff/family-register` |
| 予約確認 | `https://abc123.ngrok.io/liff/appointments` |
| Web予約 | `https://abc123.ngrok.io/liff/web-booking` |

**重要**: `abc123.ngrok.io` を実際のngrok URLに置き換えてください。

### 4. テスト用患者データ作成

D-MAXで以下のテスト患者を作成：

```
患者1（本人）:
- 患者番号: 0001
- 名前: テスト太郎
- 生年月日: 1990/01/01
- 電話: 090-1234-5678

患者2（家族）:
- 患者番号: 0002
- 名前: テスト花子
- 生年月日: 1992/05/15
- 電話: 090-1234-5678
```

### 5. テスト用予約作成

患者1で以下の予約を作成：

```
予約1（未来の予約）:
- 日時: 明日 14:00
- 診療内容: 定期検診
- 担当: 任意のスタッフ

予約2（過去の予約）:
- 日時: 1週間前 10:00
- 診療内容: クリーニング
- ステータス: 完了
```

---

## 📱 テスト手順

### テストケース1: 初回連携

**目的**: LINE User IDと患者を連携する

**手順**:
1. スマホでLINE公式アカウントを友だち追加
2. リッチメニューが表示されることを確認
3. 任意のボタンをタップ
4. 初回連携画面が表示される
5. 患者番号「0001」、生年月日「1990/01/01」を入力
6. 「連携する」ボタンをタップ
7. 連携成功メッセージが表示される

**期待結果**:
- ✅ 初回連携画面が正しく表示される
- ✅ 患者番号・生年月日で認証できる
- ✅ 連携成功後、目的の画面に遷移する

---

### テストケース2: QRコードボタン

**目的**: 受付用QRコードが表示される

**手順**:
1. リッチメニュー「QRコード」をタップ
2. QRコード画面が開く
3. 患者名「テスト太郎」が表示される
4. QRコード画像が表示される
5. 「QRコードを保存」ボタンが機能する
6. 使用回数などの情報が表示される

**期待結果**:
- ✅ 連携済み患者のQRコードが表示される
- ✅ 患者名・患者番号が正しく表示される
- ✅ QRコード画像が生成されている
- ✅ ダウンロードボタンが機能する
- ✅ 使用回数が「0回」と表示される

**パーソナライズ確認**:
- ✅ 連携患者ごとに異なるQRコードが生成される
- ✅ 家族登録後は患者選択画面が表示される

---

### テストケース3: 予約確認ボタン

**目的**: 連携患者の予約一覧が表示される

**手順**:
1. リッチメニュー「予約確認」をタップ
2. 予約一覧画面が開く
3. 患者名「テスト太郎」が表示される
4. 明日の予約（14:00 定期検診）が表示される
5. 予約詳細をタップして詳細を確認
6. 「予約をキャンセル」ボタンをタップ
7. キャンセル理由を入力
8. キャンセル実行

**期待結果**:
- ✅ 連携患者の予約のみ表示される
- ✅ 予約日時・診療内容が正しく表示される
- ✅ 担当スタッフ名が表示される
- ✅ キャンセル機能が正常に動作する
- ✅ キャンセル後、予約ステータスが「キャンセル」になる

**パーソナライズ確認**:
- ✅ 他の患者の予約は表示されない
- ✅ 家族登録後は患者選択で切り替え可能

---

### テストケース4: 予約を取るボタン

**目的**: Web予約ページに患者情報が事前入力される

**手順**:
1. リッチメニュー「予約を取る」をタップ
2. Web予約中継画面が開く
3. 患者名「テスト太郎」が表示される
4. 「Web予約ページを開く」ボタンをタップ
5. Web予約ページが開く
6. 患者情報が事前入力されている
7. 日時・診療内容を選択
8. 予約確定

**期待結果**:
- ✅ 連携患者の情報が自動入力される
  - 患者番号: 0001
  - 名前: テスト太郎
  - 生年月日: 1990/01/01
  - 電話: 090-1234-5678
- ✅ Web予約フォームが正常に動作する
- ✅ 予約完了後、予約一覧に表示される

**パーソナライズ確認**:
- ✅ 選択した患者の情報が入力される
- ✅ 家族登録後は患者選択画面が表示される

---

### テストケース5: 家族登録ボタン

**目的**: 同じLINEアカウントで複数患者を管理

**手順**:
1. リッチメニュー「家族登録」をタップ
2. 家族登録画面が開く
3. 既存の連携患者「テスト太郎」が表示される
4. 「家族を追加」ボタンをタップ
5. 患者番号「0002」、生年月日「1992/05/15」を入力
6. 続柄「child（お子様）」を選択
7. 「連携する」ボタンをタップ
8. 連携成功メッセージが表示される

**期待結果**:
- ✅ 既存連携患者が一覧表示される
- ✅ 新しい患者を追加できる
- ✅ 続柄を選択できる
- ✅ 追加後、患者選択画面で両方が表示される

**家族登録後の動作確認**:
1. リッチメニュー「QRコード」をタップ
2. 患者選択画面が表示される
   - テスト太郎（本人）
   - テスト花子（お子様）
3. 各患者を選択して異なるQRコードが表示される

---

### テストケース6: Webサイトボタン

**目的**: 医院のWebサイトに遷移

**手順**:
1. リッチメニュー「Webサイト」をタップ
2. LINEブラウザで医院のWebサイトが開く

**期待結果**:
- ✅ 設定画面で入力したWebサイトURLが開く
- ✅ 外部ブラウザではなくLINEブラウザ内で開く

**設定確認**:
- D-MAX設定 > 医院情報 > WebサイトURL
- この値がリッチメニューに自動反映される

---

### テストケース7: お問い合わせボタン（オプション）

**目的**: メッセージ送信機能の確認

**手順**:
1. リッチメニュー「お問い合わせ」をタップ
2. "CONTACT_REQUEST"というメッセージが送信される
3. 自動応答メッセージが返信される（Webhook実装済みの場合）

**期待結果**:
- ✅ メッセージが送信される
- ✅ Webhookで受信できる（実装済みの場合）

---

## 🔍 パーソナライズ機能のテスト

### シナリオ1: 1人連携（本人のみ）

**状況**: LINE User ID ↔ 患者1（テスト太郎）のみ連携

**期待される動作**:

| ボタン | 動作 |
|--------|------|
| QRコード | テスト太郎のQRを直接表示 |
| 予約確認 | テスト太郎の予約のみ表示 |
| 予約を取る | テスト太郎の情報が事前入力 |
| 家族登録 | 追加登録画面を表示 |

### シナリオ2: 複数連携（本人+家族）

**状況**: LINE User ID ↔ 患者1（テスト太郎） + 患者2（テスト花子）

**期待される動作**:

| ボタン | 動作 |
|--------|------|
| QRコード | 患者選択画面 → 選択した患者のQR表示 |
| 予約確認 | 患者選択画面 → 選択した患者の予約表示 |
| 予約を取る | 患者選択画面 → 選択した患者でWeb予約 |
| 家族登録 | 既存連携患者リスト + 追加登録画面 |

**患者選択画面の仕様**:
```
┌─────────────────────────────┐
│  患者を選択してください         │
├─────────────────────────────┤
│                             │
│  ┌───────────────────────┐ │
│  │ 👤 テスト太郎（本人）    │ │
│  │ 患者番号: 0001          │ │
│  └───────────────────────┘ │
│                             │
│  ┌───────────────────────┐ │
│  │ 👶 テスト花子（お子様）  │ │
│  │ 患者番号: 0002          │ │
│  └───────────────────────┘ │
│                             │
└─────────────────────────────┘
```

### シナリオ3: 未連携

**状況**: LINE User IDが患者に未連携

**期待される動作**:

| ボタン | 動作 |
|--------|------|
| 全ボタン | 初回連携画面にリダイレクト |

---

## ✅ テストチェックリスト

### 基本機能

- [ ] リッチメニューが表示される
- [ ] 各ボタンがタップできる
- [ ] ボタン画像が正しく表示される
- [ ] ボタンラベルが正しく表示される

### Webサイトボタン

- [ ] 医院のWebサイトが開く
- [ ] LINEブラウザ内で開く
- [ ] 設定画面のURL変更が反映される

### QRコードボタン

- [ ] 連携患者のQRコードが表示される
- [ ] 患者名・患者番号が表示される
- [ ] QRコード画像が生成される
- [ ] ダウンロード機能が動作する
- [ ] 複数連携時は患者選択画面が表示される
- [ ] 未連携時は初回連携画面が表示される

### 予約確認ボタン

- [ ] 連携患者の予約一覧が表示される
- [ ] 予約日時・診療内容が表示される
- [ ] 担当スタッフが表示される
- [ ] 予約詳細が確認できる
- [ ] キャンセル機能が動作する
- [ ] 複数連携時は患者選択画面が表示される
- [ ] 未連携時は初回連携画面が表示される

### 予約を取るボタン

- [ ] Web予約中継画面が表示される
- [ ] 患者情報が自動入力される
- [ ] Web予約ページが開く
- [ ] 予約作成が完了する
- [ ] 複数連携時は患者選択画面が表示される
- [ ] 未連携時は初回連携画面が表示される

### 家族登録ボタン

- [ ] 家族登録画面が開く
- [ ] 既存連携患者が表示される
- [ ] 新規患者を追加できる
- [ ] 続柄を選択できる
- [ ] 連携成功メッセージが表示される
- [ ] 追加後、他のボタンで患者選択が可能になる

### パーソナライズ機能

- [ ] 1人連携時: 直接その患者の情報を表示
- [ ] 複数連携時: 患者選択画面を表示
- [ ] 患者ごとに異なるQRコードを生成
- [ ] 患者ごとに異なる予約を表示
- [ ] 患者情報がWeb予約に正しく渡される

---

## 🐛 トラブルシューティング

### ボタンをタップしても反応しない

**原因**: リッチメニューが正しく設定されていない

**解決策**:
1. LINE Developers Consoleでリッチメニューを確認
2. D-MAXで「リッチメニューを作成」を再実行
3. LINE公式アカウントをブロック → 再度友だち追加

### LIFF画面が開かない

**原因**: LIFF Endpoint URLが間違っている

**解決策**:
1. ngrok URLが正しいか確認（再起動すると変わります）
2. LINE Developers ConsoleでLIFF Endpoint URLを更新
3. `https://` で始まるか確認

### 「LIFF IDが設定されていません」エラー

**原因**: 環境変数が読み込まれていない

**解決策**:
1. D-MAX設定画面でLIFF IDを入力・保存
2. 開発サーバーを再起動
   ```bash
   Ctrl+C
   npm run dev
   ```
3. ブラウザキャッシュをクリア

### 「患者が見つかりません」エラー

**原因**: 初回連携が完了していない

**解決策**:
1. まず初回連携を完了する
2. 患者番号・生年月日が正しいか確認
3. データベースに患者データが存在するか確認

### QRコードが表示されない

**原因**: QRコード生成APIエラー

**解決策**:
1. 開発サーバーのログを確認
2. `/api/patients/[id]/qr-code` が動作しているか確認
3. 患者IDが正しいか確認

### 予約が表示されない

**原因**: 予約データが存在しない、またはAPI接続エラー

**解決策**:
1. D-MAXで予約を作成
2. 開発サーバーのログを確認
3. `/api/line/appointments` が動作しているか確認
4. LINE User IDと患者が正しく連携されているか確認

---

## 📊 テスト結果記録

### テスト実施情報

```
テスト日時:
テスト担当者:
LINE公式アカウント名:
環境: 開発環境（ngrok）
```

### テスト結果

| テストケース | 結果 | 備考 |
|------------|------|------|
| 初回連携 | ☐ Pass ☐ Fail |  |
| QRコードボタン | ☐ Pass ☐ Fail |  |
| 予約確認ボタン | ☐ Pass ☐ Fail |  |
| 予約を取るボタン | ☐ Pass ☐ Fail |  |
| 家族登録ボタン | ☐ Pass ☐ Fail |  |
| Webサイトボタン | ☐ Pass ☐ Fail |  |
| お問い合わせボタン | ☐ Pass ☐ Fail |  |
| パーソナライズ機能 | ☐ Pass ☐ Fail |  |

### 発見された問題

```
1.

2.

3.
```

---

## 📝 まとめ

このテストガイドを使用して、LINEリッチメニューの全機能を体系的にテストできます。

**重要なポイント**:
- ✅ 各ボタンは患者ごとにパーソナライズされる
- ✅ 未連携時は自動的に初回連携画面へ誘導
- ✅ 複数連携時は患者選択画面を表示
- ✅ 1人連携時は直接その患者の情報を表示

**次のステップ**:
1. このガイドに従ってテスト実施
2. 問題があれば修正
3. 本番環境デプロイ前に再テスト
4. 医院スタッフ向けトレーニング

テストが完了したら、本番環境へのデプロイ準備を進めましょう！
