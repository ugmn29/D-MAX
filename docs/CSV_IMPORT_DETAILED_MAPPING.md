# 売上CSV取り込み項目詳細マッピング

## 取り込み可能な情報一覧

### ✅ 完全対応項目（自動マッピング）

| 項目 | CSV列名例 | 取り込み先 | 説明 |
|-----|---------|----------|------|
| **患者情報** | `患者番号`, `patient_id` | `sales.patient_id` | 既存患者と自動マッチング |
| 患者氏名 | `患者氏名`, `patient_name` | 参照のみ | マッチング補助に使用 |
| **診療日** | `診療日`, `treatment_date` | `sales.treatment_date` | 実際に診療した日 |
| 会計日 | `会計日`, `sale_date` | `sales.sale_date` | 診療日と異なる場合 |
| **レセプト番号** | `レセプト番号`, `receipt_number` | `sales.receipt_number` | 重複防止に使用 |
| **保険種別** | `保険種別`, `insurance_type` | `sales.insurance_type` | 社保/国保/後期/自費 |
| 保険点数 | `保険点数`, `insurance_points` | `sales.insurance_points` | 診療報酬点数 |
| 保険請求額 | `請求額`, `insurance_amount` | `sales.insurance_amount` | 保険請求総額 |
| **患者負担額** | `入金額`, `patient_copay` | `sales.patient_copay` | 保険診療の窓口負担 |
| **自費診療額** | `自費額`, `self_pay_amount` | `sales.self_pay_amount` | 自由診療の金額 |
| **合計金額** | `合計金額`, `total_amount` | `sales.total_amount` | 患者が支払った総額 |
| **支払方法** | `入金方法`, `payment_method` | `sales.payment_method` | 現金/カード/QR |
| **担当スタッフ** | `担当Dr`, `staff_name` | `sales.staff_id` | 既存スタッフと自動マッチング |
| **診療メニュー** | `診療内容`, `treatment_menu` | `sales.treatment_menu_id` | 既存メニューと自動マッチング |
| 診療行為コード | `診療コード`, `treatment_codes` | `sales.treatment_codes` | レセプトコード配列 |
| 備考 | `備考`, `notes` | `sales.notes` | 自由記述 |

### 🔶 部分対応項目（手動対応が必要な場合あり）

| 項目 | 対応方法 | 説明 |
|-----|---------|------|
| 初診/再診区分 | `notes`または`treatment_details`に格納 | 診療メニューで判別可能 |
| 診療時間 | `treatment_details`に格納 | JSON形式で保存 |
| 使用材料 | `treatment_details`に格納 | 詳細情報として保存 |
| 処置内容 | `treatment_details`に格納 | 自由形式で保存 |

---

## 実際のCSV例と取り込み結果

### 例1: 保険診療（う蝕処置）

**CSVデータ**:
```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00123,山田太郎,2025/01/11,社保,1500,15000,4500,0,4500,現金,佐藤花子,初診・う蝕処置,右上4
```

**取り込み結果**:
```json
{
  "patient_id": "uuid-of-patient-00123",
  "patient_name": "山田太郎",
  "treatment_date": "2025-01-11",
  "insurance_type": "社保",
  "insurance_points": 1500,
  "insurance_amount": 15000,
  "patient_copay": 4500,
  "self_pay_amount": 0,
  "total_amount": 4500,
  "payment_method": "現金",
  "staff_id": "uuid-of-staff-佐藤花子",
  "treatment_menu_id": "uuid-of-menu-う蝕処置",
  "category": "insurance",
  "notes": "右上4"
}
```

**分析画面での表示**:
- 売上: **4,500円**（保険診療）
- 担当: **佐藤花子**
- メニュー: **う蝕処置**
- 保険点数: **1,500点**

---

### 例2: 自費診療（インプラント）

**CSVデータ**:
```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00456,田中花子,2025/01/11,自費,0,0,0,350000,350000,クレジットカード,鈴木一郎,インプラント埋入,下顎左6
```

**取り込み結果**:
```json
{
  "patient_id": "uuid-of-patient-00456",
  "patient_name": "田中花子",
  "treatment_date": "2025-01-11",
  "insurance_type": "自費",
  "insurance_points": 0,
  "insurance_amount": 0,
  "patient_copay": 0,
  "self_pay_amount": 350000,
  "total_amount": 350000,
  "payment_method": "クレジットカード",
  "staff_id": "uuid-of-staff-鈴木一郎",
  "treatment_menu_id": "uuid-of-menu-インプラント",
  "category": "self_pay",
  "notes": "下顎左6"
}
```

**分析画面での表示**:
- 売上: **350,000円**（自費診療）
- 担当: **鈴木一郎**
- メニュー: **インプラント**
- 支払: **クレジットカード**

---

### 例3: 保険+自費の混合診療

**CSVデータ**:
```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00789,佐藤次郎,2025/01/11,社保,2500,25000,7500,80000,87500,クレジットカード,佐藤花子,歯周治療+ホワイトニング,保険併用
```

**取り込み結果**:
```json
{
  "patient_id": "uuid-of-patient-00789",
  "patient_name": "佐藤次郎",
  "treatment_date": "2025-01-11",
  "insurance_type": "社保",
  "insurance_points": 2500,
  "insurance_amount": 25000,
  "patient_copay": 7500,
  "self_pay_amount": 80000,
  "total_amount": 87500,
  "payment_method": "クレジットカード",
  "staff_id": "uuid-of-staff-佐藤花子",
  "treatment_menu_id": "uuid-of-menu-歯周治療", // 最初のメニューをマッチング
  "category": "insurance", // 保険診療として分類（自費も含む）
  "notes": "保険併用",
  "treatment_details": {
    "menus": ["歯周治療", "ホワイトニング"],
    "insurance_part": 7500,
    "self_pay_part": 80000
  }
}
```

**分析画面での表示**:
- 売上: **87,500円**（保険7,500円 + 自費80,000円）
- 担当: **佐藤花子**
- メニュー: **歯周治療+ホワイトニング**（混合診療）

---

## 詳細な診療内容の取り込み

電子カルテによっては、より詳細なCSVを出力できる場合があります。

### 拡張フォーマット例

```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,診療コード,処置歯,処置時間,使用材料,備考
00123,山田太郎,2025/01/11,社保,1500,15000,4500,0,4500,現金,佐藤花子,う蝕処置,"101010,102020",右上4,30分,CR充填,初診
```

**取り込み結果（拡張版）**:
```json
{
  "patient_id": "uuid-of-patient-00123",
  "treatment_date": "2025-01-11",
  "insurance_type": "社保",
  "total_amount": 4500,
  "payment_method": "現金",
  "staff_id": "uuid-of-staff-佐藤花子",
  "treatment_menu_id": "uuid-of-menu-う蝕処置",
  "treatment_codes": ["101010", "102020"],
  "treatment_details": {
    "tooth": "右上4",
    "duration": "30分",
    "materials": "CR充填",
    "procedure": "う蝕処置"
  },
  "notes": "初診"
}
```

---

## 分析画面での活用例

取り込んだデータを元に、以下の分析が可能になります：

### 1. スタッフ別売上分析

**佐藤花子の売上（2025年1月）**:
- 保険診療: 15件 / 67,500円
- 自費診療: 3件 / 540,000円
- **合計: 18件 / 607,500円**

### 2. 診療メニュー別売上

**2025年1月の診療メニュー別売上**:
| メニュー | 件数 | 売上 |
|---------|------|------|
| インプラント | 5件 | 1,750,000円 |
| ホワイトニング | 12件 | 480,000円 |
| う蝕処置 | 45件 | 202,500円 |
| 歯周治療 | 30件 | 180,000円 |

### 3. 自費診療率

**2025年1月の自費率**:
- 総売上: 2,612,500円
- 自費売上: 2,230,000円
- **自費率: 85.4%** ⬆

### 4. 支払方法別集計

**2025年1月の決済方法**:
| 方法 | 件数 | 金額 |
|------|------|------|
| クレジットカード | 52件 | 1,980,000円 (75.8%) |
| 現金 | 35件 | 532,500円 (20.4%) |
| QR決済 | 5件 | 100,000円 (3.8%) |

### 5. 日別売上推移

**グラフ表示**:
```
売上（万円）
40 |     ▄▄
35 |    ███▄
30 |   ████▄
25 |  ▄█████▄
20 | ████████▄▄
15 |████████████
10 |████████████▄
 5 |█████████████
 0 +─────────────
   1  5  10 15 20 25 31 (日)
```

---

## 電子カルテ別の出力可能項目

### ノーザ オプテック

**標準出力項目**:
- ✅ 患者番号
- ✅ 患者氏名
- ✅ 診療日
- ✅ 保険種別（コード）
- ✅ 保険点数
- ✅ 請求額
- ✅ 入金額（患者負担）
- ✅ 自費額
- ✅ 合計金額
- ✅ 入金方法（コード）
- ✅ 担当Dr
- ✅ 診療内容
- ✅ 備考

**オプション項目**（カスタマイズで追加可能）:
- ⚠️ 診療行為コード（レセコン連携時）
- ⚠️ 処置歯番号
- ⚠️ 処置時間
- ⚠️ 使用材料

### Dental X（モリタ）

**標準出力項目**:
- ✅ カルテ番号
- ✅ 患者氏名
- ✅ 診療日
- ✅ 保険種別
- ✅ 点数
- ✅ 請求額
- ✅ 患者負担
- ✅ 自費額
- ✅ 合計
- ✅ 支払方法
- ✅ 担当者
- ✅ 診療内容
- ✅ 診療行為コード（詳細設定時）

### デンタルマップ

**標準出力項目**:
- ✅ 患者ID
- ✅ 患者名
- ✅ 診療日
- ✅ 保険区分
- ✅ 点数
- ✅ 保険額
- ✅ 負担金
- ✅ 自費
- ✅ 合計額
- ✅ 決済方法
- ✅ Dr
- ✅ 備考

---

## よくある質問

### Q1: 診療メニューが複数ある場合はどうなりますか？

**A**: 2つの方法で対応できます：

**方法1**: カンマ区切りで全て記録
```csv
診療内容,備考
"歯周治療, ホワイトニング, クリーニング",複数メニュー
```
→ `treatment_details`に配列で保存

**方法2**: メインメニューのみマッチング
```csv
診療内容,備考
歯周治療,ホワイトニング・クリーニングも実施
```
→ メインの「歯周治療」のみ`treatment_menu_id`にマッチング、詳細は備考へ

### Q2: スタッフ名が一致しない場合は？

**A**: 以下の順序で処理されます：
1. 完全一致で検索
2. 部分一致で検索（例: 「佐藤花子」→「佐藤」）
3. 見つからない場合は`staff_id = NULL`として登録
4. エラーログに記録（後で手動割り当て可能）

### Q3: 患者番号が見つからない場合は？

**A**: 2つの対応方法：
1. **エラーとして扱う**（デフォルト）
   - インポートを停止
   - エラーレポートを表示
   - 該当患者を先に登録してから再実行

2. **スキップして続行**
   - 「エラー行をスキップ」オプション有効時
   - その行のみスキップ、他は続行
   - エラーログに記録

### Q4: 自費+保険の混合診療はどう集計されますか？

**A**: 両方を記録して柔軟に集計できます：
- `insurance_amount`: 保険請求額
- `patient_copay`: 保険の患者負担
- `self_pay_amount`: 自費額
- `total_amount`: 合計

分析画面で以下のような集計が可能：
- 保険診療のみの売上
- 自費診療のみの売上
- 混合診療を含む総売上
- 自費率の計算

---

## まとめ

### ✅ 取り込める情報
- 患者情報（自動マッチング）
- 金額情報（保険/自費/合計）
- スタッフ情報（自動マッチング）
- 診療メニュー（自動マッチング）
- 支払方法
- 診療日・会計日
- 備考・詳細情報

### 📊 可能な分析
- スタッフ別売上
- 診療メニュー別売上
- 日別・月別推移
- 自費診療率
- 支払方法別集計
- 時間帯別分析（データがあれば）

### 🔧 必要な設定
1. 電子カルテでCSV出力項目を設定
2. 患者マスタの同期（患者番号の一致）
3. スタッフマスタの登録
4. 診療メニューマスタの登録

すべての情報が詳細に取り込まれ、多角的な分析が可能になります！
