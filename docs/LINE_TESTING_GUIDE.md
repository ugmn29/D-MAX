# LINE連携システム テスト手順書

## 前提条件

### 必要な環境
- ✅ ngrokが起動済み（URL: `https://lofty-herlinda-compulsively.ngrok-free.dev`）
- ✅ 開発サーバーが起動済み（localhost:3000）
- ✅ Supabaseローカル環境が起動済み
- 📱 スマートフォン（LINE アプリがインストール済み）

---

## ステップ1: LINE Developersアカウント設定

### 1-1. LINE Developers Console にアクセス
1. https://developers.line.biz/console/ にアクセス
2. LINEアカウントでログイン

### 1-2. プロバイダーを作成
1. 「新規プロバイダー作成」をクリック
2. プロバイダー名を入力（例: D-MAX Dental Clinic）
3. 「作成」をクリック

### 1-3. Messaging API チャネルを作成
1. 作成したプロバイダーを選択
2. 「新規チャネル作成」→「Messaging API」を選択
3. 以下を入力:
   - **チャネル名**: D-MAX LINE Bot（テスト用）
   - **チャネル説明**: 歯科クリニック管理システムのLINE連携機能
   - **大業種**: 医療・福祉
   - **小業種**: 病院・診療所
   - **メールアドレス**: あなたのメールアドレス
4. 利用規約に同意して「作成」

### 1-4. チャネル設定
1. 作成したチャネルを選択
2. 「Messaging API設定」タブを開く

#### チャネルアクセストークンを発行
1. 「チャネルアクセストークン（長期）」セクションで「発行」をクリック
2. 発行されたトークンをコピー（後で使用）

#### Webhook設定
1. 「Webhook設定」セクションで以下を設定:
   - **Webhook URL**: `https://lofty-herlinda-compulsively.ngrok-free.dev/api/line/webhook`
   - **Webhookの利用**: 「オン」にする
   - **検証」ボタンをクリック（成功すればOK）

#### 応答メッセージ設定
1. 「LINE公式アカウント機能」セクションで:
   - **応答メッセージ**: 「オフ」にする
   - **あいさつメッセージ**: お好みで設定

#### Channel Secretを取得
1. 「チャネル基本設定」タブを開く
2. 「Channel secret」をコピー（後で使用）

---

## ステップ2: LIFFアプリを作成（5個）

チャネルの「LIFF」タブで以下の5つのLIFFアプリを作成します。

### LIFF 1: 初回連携
- **LIFFアプリ名**: D-MAX 初回連携
- **サイズ**: Tall
- **エンドポイントURL**: `https://lofty-herlinda-compulsively.ngrok-free.dev/liff/initial-link`
- **Scope**: `profile`, `openid`
- **ボットリンク機能**: オン

### LIFF 2: QRコード表示
- **LIFFアプリ名**: D-MAX QRコード
- **サイズ**: Tall
- **エンドポイントURL**: `https://lofty-herlinda-compulsively.ngrok-free.dev/liff/qr-code`
- **Scope**: `profile`, `openid`
- **ボットリンク機能**: オン

### LIFF 3: 家族登録
- **LIFFアプリ名**: D-MAX 家族登録
- **サイズ**: Tall
- **エンドポイントURL**: `https://lofty-herlinda-compulsively.ngrok-free.dev/liff/family-register`
- **Scope**: `profile`, `openid`
- **ボットリンク機能**: オン

### LIFF 4: 予約確認
- **LIFFアプリ名**: D-MAX 予約確認
- **サイズ**: Full
- **エンドポイントURL**: `https://lofty-herlinda-compulsively.ngrok-free.dev/liff/appointments`
- **Scope**: `profile`, `openid`
- **ボットリンク機能**: オン

### LIFF 5: Web予約
- **LIFFアプリ名**: D-MAX Web予約
- **サイズ**: Full
- **エンドポイントURL**: `https://lofty-herlinda-compulsively.ngrok-free.dev/liff/web-booking`
- **Scope**: `profile`, `openid`
- **ボットリンク機能**: オン

各LIFFアプリ作成後、**LIFF ID**（例: `1234567890-abcdefgh`）をコピーしてメモしておきます。

---

## ステップ3: 環境変数を設定

`.env.local` ファイルに以下を追加・更新します：

```bash
# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=【ステップ1-4でコピーしたチャネルアクセストークン】
LINE_CHANNEL_SECRET=【ステップ1-4でコピーしたChannel Secret】

# LIFF設定
NEXT_PUBLIC_LIFF_ID_INITIAL_LINK=【LIFF 1のLIFF ID】
NEXT_PUBLIC_LIFF_ID_QR_CODE=【LIFF 2のLIFF ID】
NEXT_PUBLIC_LIFF_ID_FAMILY_REGISTER=【LIFF 3のLIFF ID】
NEXT_PUBLIC_LIFF_ID_APPOINTMENTS=【LIFF 4のLIFF ID】
NEXT_PUBLIC_LIFF_ID_WEB_BOOKING=【LIFF 5のLIFF ID】
```

保存後、開発サーバーを再起動します：

```bash
# ターミナルで Ctrl+C で停止してから
npm run dev
```

---

## ステップ4: リッチメニューを設定

### 4-1. ブラウザで設定画面を開く
http://localhost:3000/settings にアクセス

### 4-2. LINE設定タブを開く
1. 左メニューから「LINE設定」を選択
2. 「リッチメニュー設定」セクションまでスクロール

### 4-3. リッチメニューを反映
1. リッチメニューのデザインとボタン配置を確認
2. 「リッチメニューを反映」ボタンをクリック
3. 成功メッセージが表示されればOK

---

## ステップ5: LINE友だち追加

### 5-1. QRコードを取得
1. LINE Developers Console → 作成したチャネル → 「Messaging API設定」タブ
2. 「Bot情報」セクションにあるQRコードを表示

### 5-2. スマホで友だち追加
1. スマホでLINEアプリを開く
2. 友だち追加 → QRコード読み取り
3. 表示されたQRコードを読み取る
4. 「追加」をタップ

### 5-3. リッチメニューを確認
友だち追加後、トーク画面の下部にリッチメニューが表示されることを確認します：

```
┌──────────┬──────────┬──────────┐
│          │          │          │
│Webサイト │ QRコード │ 予約確認 │
│          │          │          │
├──────────┼──────────┴──────────┤
│          │                     │
│家族登録  │    予約を取る       │
│          │                     │
├──────────┤                     │
│          │                     │
│お問合せ  │                     │
│          │                     │
└──────────┴─────────────────────┘
```

---

## ステップ6: テストシナリオ

### シナリオ1: 初回連携（新規患者）

#### 6-1. テスト用患者データを作成
1. http://localhost:3000/patients にアクセス
2. 「新規患者登録」をクリック
3. 以下のテストデータを入力:
   - 姓: 山田
   - 名: 太郎
   - フリガナ（姓）: ヤマダ
   - フリガナ（名）: タロウ
   - 生年月日: 1990-01-01
   - 性別: 男性
   - 電話番号: 09012345678
   - メールアドレス: test@example.com
4. 「登録」をクリック

#### 6-2. 招待コードを発行
1. 登録した患者の詳細ページを開く
2. 「基本情報」タブの「LINE連携」セクションを確認
3. 「招待コードを発行」ボタンをクリック
4. 表示された8桁の招待コード（例: AB12-CD34）をメモ

#### 6-3. LINEで初回連携
1. スマホのLINEで、友だち追加したBotのトーク画面を開く
2. **リッチメニューはまだ使えません**（連携前は表示されない設計の場合）
3. トークに「初回登録」と入力して送信
   - または、以下のURLを直接開く:
   - `https://liff.line.me/【LIFF 1のID】`
4. LIFF画面が開いたら:
   - 招待コード入力欄に、メモした招待コードを入力（ハイフンなしでもOK）
   - 生年月日入力欄に「19900101」と入力（自動で1990/01/01にフォーマットされる）
   - 「連携する」ボタンをタップ
5. 「連携完了！」画面が表示され、3秒後に自動的に閉じる

#### 6-4. 連携を確認
1. ブラウザで患者詳細ページをリロード
2. 「LINE連携」セクションに「LINE連携済み」バッジが表示される

---

### シナリオ2: QRコード表示

#### 7-1. リッチメニューからQRコードを開く
1. LINEのトーク画面で、リッチメニューの「QRコード」をタップ
2. LIFF画面が開き、患者のQRコードが表示される

#### 7-2. QRコードの内容を確認
- 患者名: 山田 太郎
- 患者番号: （自動採番された番号）
- 使用回数: 0回
- 「QRコードを保存」ボタンで画像として保存可能

---

### シナリオ3: 家族登録

#### 8-1. テスト用家族データを作成
1. http://localhost:3000/patients にアクセス
2. 「新規患者登録」で子供の患者データを作成:
   - 姓: 山田
   - 名: 花子
   - 生年月日: 2010-05-15
   - 電話番号: 09012345678（親と同じ）
3. 「登録」をクリック

#### 8-2. LINEで家族を検索・登録
1. LINEのリッチメニューから「家族登録」をタップ
2. LIFF画面が開いたら:
   - 氏名: 「山田」と入力
   - 生年月日: 「20100515」と入力（自動で2010/05/15にフォーマット）
   - 電話番号: 「09012345678」と入力
   - 「検索する」ボタンをタップ
3. 検索結果に「山田 花子」が表示される
   - 患者番号とマスキングされた電話番号（090-****-5678）が表示
4. 結果をタップして選択
5. 「あなたとの関係」で「子供」を選択
6. 「登録する」ボタンをタップ
7. 「登録完了！」画面が表示され、3秒後に閉じる

---

### シナリオ4: 予約確認とキャンセル

#### 9-1. テスト用予約データを作成
1. http://localhost:3000/appointments にアクセス
2. 「新規予約」をクリック
3. 以下を入力:
   - 患者: 山田 太郎
   - 予約日: 明日の日付
   - 時間: 10:00
   - 診療内容: 定期検診
4. 「登録」をクリック

#### 9-2. LINEで予約を確認
1. LINEのリッチメニューから「予約確認」をタップ
2. LIFF画面が開き、予約一覧が表示される
3. 複数の患者（自分＋家族）がいる場合:
   - 左右の矢印で患者を切り替え可能
   - 現在表示中: 「山田 太郎 (1 / 2)」のように表示

#### 9-3. 予約の詳細を確認
予約カードに以下が表示されます:
- 日付: ○月○日（○）
- 時間: 10:00（30分）
- 治療内容: 定期検診
- ステータス: 予約済み
- 担当医: （設定していれば表示）

#### 9-4. 予約をキャンセル
1. 「この予約をキャンセル」ボタンをタップ
2. 確認ダイアログが表示される
3. キャンセル理由（任意）を入力: 「体調不良のため」
4. 「キャンセルする」ボタンをタップ
5. 「キャンセル完了」画面が表示され、予約一覧が自動更新される

---

### シナリオ5: Web予約

#### 10-1. LINEからWeb予約を開く
1. LINEのリッチメニューから「予約を取る」をタップ
2. LIFF画面が開き、連携患者一覧が表示される

#### 10-2. 患者を選択
1. 複数の患者がいる場合、予約したい患者を選択
2. 選択した患者の情報（名前・患者番号・生年月日）が表示される
3. 「Web予約画面を開く」ボタンをタップ

#### 10-3. Web予約フォームで予約
1. Web予約画面が開く
2. **患者情報が自動入力されている**ことを確認:
   - 氏名: 山田 太郎（自動入力済み）
   - 電話番号: 090-1234-5678（自動入力済み）
   - メールアドレス: test@example.com（自動入力済み）
3. 診療メニューを選択
4. 希望日時を選択
5. 「予約する」ボタンをタップ
6. 予約完了

---

## トラブルシューティング

### LIFF画面が開かない
**症状**: リッチメニューをタップしても反応がない

**対処法**:
1. LIFF IDが正しく設定されているか確認（`.env.local`）
2. 開発サーバーを再起動
3. ngrokのURLが正しいか確認
4. LIFF設定のエンドポイントURLにngrokのURLを使用しているか確認

### 招待コードが「無効」と表示される
**症状**: 「招待コードが見つからないか、有効期限が切れています」

**対処法**:
1. 招待コードを正しく入力したか確認（ハイフンは自動で挿入される）
2. 招待コードの有効期限（30日）を確認
3. ブラウザで患者詳細ページを開き、新しい招待コードを発行

### 生年月日が一致しない
**症状**: 「生年月日が一致しません」

**対処法**:
1. 患者マスタの生年月日を確認
2. 入力形式が正しいか確認（YYYY/MM/DD）
3. 年・月・日が正確か確認

### 予約が表示されない
**症状**: 予約確認画面に「予約がありません」と表示される

**対処法**:
1. 今日以降の予約を作成したか確認（過去の予約は表示されない）
2. ステータスが「cancelled」や「completed」でないか確認
3. 正しい患者に予約が紐付いているか確認

### QRコードが生成されない
**症状**: QRコード画面でエラーが表示される

**対処法**:
1. 患者が正しく連携されているか確認
2. ブラウザのコンソールでエラーを確認
3. `/api/patients/[patient_id]/qr-code` にアクセスしてAPIが動作しているか確認

---

## 成功の確認ポイント

以下がすべて動作すれば、LINE連携システムは正常に機能しています：

- ✅ 招待コードで患者とLINEアカウントを連携できる
- ✅ QRコードが表示され、保存できる
- ✅ 家族メンバーを検索・登録できる
- ✅ 予約一覧が表示され、キャンセルできる
- ✅ Web予約で患者情報が自動入力される
- ✅ 複数患者（家族）の切り替えができる
- ✅ リッチメニューからすべての機能にアクセスできる

---

## 次のステップ

テストが成功したら、以下の本番環境への移行準備を行います：

1. **本番用LINEチャネル作成**
   - 本番用のMessaging APIチャネルを新規作成
   - 本番ドメインでLIFFアプリを設定

2. **環境変数の分離**
   - 開発環境と本番環境でLINE認証情報を分ける
   - Vercelなどのホスティングサービスで環境変数を設定

3. **Webhook URLの変更**
   - ngrok URLから本番ドメインのURLに変更

4. **データベースマイグレーション**
   - `npx supabase db push` で本番データベースに反映

5. **運用開始**
   - スタッフへの操作説明
   - 患者への案内文作成
   - テスト運用期間の設定

---

お疲れ様でした！🎉
LINE連携システムの完全なテストが完了しました。
