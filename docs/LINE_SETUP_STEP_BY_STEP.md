# LINE連携システム 設定手順（医院向け）

## 📱 この設定でできるようになること

患者さんがLINEで以下のことができるようになります：
- ✅ LINEで診察券（QRコード）を表示
- ✅ LINEで予約の確認・キャンセル
- ✅ LINEから簡単にWeb予約
- ✅ 家族全員の診察券を1つのLINEで管理

**所要時間**: 約30分（初回のみ）

---

## 事前準備

### 必要なもの
1. **LINEアカウント**（普段使っているもので OK）
2. **パソコン**（設定作業用）
3. **スマートフォン**（テスト用）
4. **メールアドレス**（連絡用）

### 確認事項
- D-MAXシステムが稼働していること
- インターネットに接続できること

---

## ステップ1: LINE Developers アカウントを作る（5分）

### 1-1. LINE Developersにアクセス

ブラウザで以下のURLを開きます：
```
https://developers.line.biz/console/
```

### 1-2. ログイン

1. 「LINEアカウントでログイン」ボタンをクリック
2. 普段使っているLINEのメールアドレスとパスワードを入力
3. 「ログイン」をクリック

![LINE Developers ログイン画面](画像があれば挿入)

### 1-3. 初回登録（初めての場合のみ）

1. 開発者名を入力（例: 山田歯科クリニック）
2. メールアドレスを入力
3. 利用規約に同意してチェック
4. 「登録」をクリック

---

## ステップ2: プロバイダーを作る（2分）

### 2-1. 新規プロバイダー作成

1. LINE Developers のトップページで「新規プロバイダー作成」をクリック

![プロバイダー作成ボタン](画像があれば挿入)

### 2-2. プロバイダー名を入力

```
プロバイダー名: 〇〇歯科クリニック
（例: 山田歯科クリニック）
```

⚠️ **注意**: この名前が患者さんに表示されます！

### 2-3. 作成ボタンをクリック

「作成」ボタンをクリックして完了

---

## ステップ3: LINE公式アカウントを作る（5分）

### 3-1. Messaging APIチャネル作成

1. 作成したプロバイダー（例: 山田歯科クリニック）をクリック
2. 「新規チャネル作成」ボタンをクリック
3. 「Messaging API」を選択

![チャネル作成画面](画像があれば挿入)

### 3-2. チャネル情報を入力

以下の項目を入力します：

#### チャネルアイコン
- クリニックのロゴ画像をアップロード（推奨: 512×512px）
- なければスキップOK（後で変更可能）

#### チャネル名
```
チャネル名: 〇〇歯科クリニック
（例: 山田歯科クリニック）
```
⚠️ **これが患者さんに表示される LINE公式アカウント名です！**

#### チャネル説明
```
〇〇歯科クリニックの公式LINEアカウントです。
診察券の表示、予約の確認・変更ができます。
```

#### 大業種
```
医療・福祉
```

#### 小業種
```
病院・診療所
```

#### メールアドレス
```
（クリニックの連絡用メールアドレス）
```

### 3-3. 利用規約に同意

1. プライバシーポリシーと利用規約を確認
2. チェックボックスにチェック
3. 「作成」ボタンをクリック

---

## ステップ4: 重要な設定をする（10分）

### 4-1. チャネルアクセストークンを発行

作成したチャネルの画面で：

1. 「Messaging API設定」タブをクリック
2. 下にスクロールして「チャネルアクセストークン（長期）」を見つける
3. 「発行」ボタンをクリック
4. 表示されたトークン（長い英数字）を**コピー**

```
例:
eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lL...
（実際はもっと長い）
```

⚠️ **超重要**: このトークンは絶対に他人に見せないでください！
📝 **メモ帳に保存**しておいてください（後で使います）

### 4-2. Channel Secretを取得

1. 「チャネル基本設定」タブをクリック
2. 下にスクロールして「Channel Secret」を見つける
3. 「表示」ボタンをクリック
4. 表示された値を**コピー**

```
例: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

📝 **メモ帳に保存**しておいてください

### 4-3. Webhook URLを設定

1. 「Messaging API設定」タブに戻る
2. 「Webhook設定」セクションを見つける
3. 「編集」ボタンをクリック
4. 以下のURLを入力：

```
【本番環境の場合】
https://あなたのドメイン.com/api/line/webhook

【テスト環境の場合】
https://lofty-herlinda-compulsively.ngrok-free.dev/api/line/webhook
```

5. 「Webhookの利用」を**オン**にする
6. 「検証」ボタンをクリック
7. ✅「成功しました」と表示されればOK

### 4-4. 応答メッセージをオフにする

1. 同じ「Messaging API設定」タブで「LINE公式アカウント機能」セクションを見つける
2. 「応答メッセージ」を**オフ**にする
   - オフにしないと、自動応答メッセージが勝手に送られます
3. 「あいさつメッセージ」は**お好みで**設定

---

## ステップ5: LIFFアプリを作る（15分）

LIFFアプリを**5個**作成します。

### 5-1. LIFF タブを開く

1. チャネル画面の「LIFF」タブをクリック
2. 「追加」ボタンをクリック

### 5-2. LIFF 1個目: 初回連携

以下の項目を入力：

#### LIFFアプリ名
```
〇〇歯科クリニック - 初回連携
```

#### サイズ
```
Tall
```

#### エンドポイントURL
```
【本番環境】
https://あなたのドメイン.com/liff/initial-link

【テスト環境】
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/initial-link
```

#### Scope
- ✅ `profile`（チェック）
- ✅ `openid`（チェック）
- ☑️ `chat_message.write`（チェック不要）

#### ボットリンク機能
```
On (Aggressive)
```

#### 作成
「追加」ボタンをクリック

#### LIFF ID をコピー
作成後、表示される LIFF ID（例: `1234567890-abcdefgh`）を**コピー**
📝 **メモ帳に「LIFF 1: 1234567890-abcdefgh」と保存**

---

### 5-3. LIFF 2個目: QRコード表示

「追加」ボタンをもう一度クリックして、以下を入力：

#### LIFFアプリ名
```
〇〇歯科クリニック - QRコード
```

#### サイズ
```
Tall
```

#### エンドポイントURL
```
【本番環境】
https://あなたのドメイン.com/liff/qr-code

【テスト環境】
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/qr-code
```

#### Scope
- ✅ `profile`
- ✅ `openid`

#### ボットリンク機能
```
On (Aggressive)
```

#### LIFF ID をコピー
📝 **メモ帳に「LIFF 2: 1234567890-xxxxxxxx」と保存**

---

### 5-4. LIFF 3個目: 家族登録

#### LIFFアプリ名
```
〇〇歯科クリニック - 家族登録
```

#### サイズ
```
Tall
```

#### エンドポイントURL
```
【本番環境】
https://あなたのドメイン.com/liff/family-register

【テスト環境】
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/family-register
```

#### Scope
- ✅ `profile`
- ✅ `openid`

#### ボットリンク機能
```
On (Aggressive)
```

#### LIFF ID をコピー
📝 **メモ帳に「LIFF 3: 1234567890-yyyyyyyy」と保存**

---

### 5-5. LIFF 4個目: 予約確認

#### LIFFアプリ名
```
〇〇歯科クリニック - 予約確認
```

#### サイズ
```
Full
```
⚠️ **注意**: ここだけ「Full」です！

#### エンドポイントURL
```
【本番環境】
https://あなたのドメイン.com/liff/appointments

【テスト環境】
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/appointments
```

#### Scope
- ✅ `profile`
- ✅ `openid`

#### ボットリンク機能
```
On (Aggressive)
```

#### LIFF ID をコピー
📝 **メモ帳に「LIFF 4: 1234567890-zzzzzzzz」と保存**

---

### 5-6. LIFF 5個目: Web予約

#### LIFFアプリ名
```
〇〇歯科クリニック - Web予約
```

#### サイズ
```
Full
```
⚠️ **注意**: ここも「Full」です！

#### エンドポイントURL
```
【本番環境】
https://あなたのドメイン.com/liff/web-booking

【テスト環境】
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/web-booking
```

#### Scope
- ✅ `profile`
- ✅ `openid`

#### ボットリンク機能
```
On (Aggressive)
```

#### LIFF ID をコピー
📝 **メモ帳に「LIFF 5: 1234567890-wwwwwwww」と保存**

---

### ✅ LIFF作成完了チェック

メモ帳に以下の情報が揃っているか確認：

```
✅ チャネルアクセストークン: eyJhbGciOiJIUzI1NiJ9...
✅ Channel Secret: a1b2c3d4e5f6g7h8i9j0...
✅ LIFF 1 (初回連携): 1234567890-abcdefgh
✅ LIFF 2 (QRコード): 1234567890-xxxxxxxx
✅ LIFF 3 (家族登録): 1234567890-yyyyyyyy
✅ LIFF 4 (予約確認): 1234567890-zzzzzzzz
✅ LIFF 5 (Web予約): 1234567890-wwwwwwww
```

---

## ステップ6: D-MAXに設定を登録（3分）

### 6-1. D-MAXの設定画面を開く

ブラウザで D-MAX にアクセス：
```
http://localhost:3000/settings
（または本番環境のURL）
```

### 6-2. 環境変数を設定

**方法A: .env.local ファイルを直接編集**

1. D-MAXのフォルダを開く
2. `.env.local` ファイルを開く（なければ作成）
3. 以下を追加・更新：

```bash
# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=【ステップ4-1でコピーしたトークン】
LINE_CHANNEL_SECRET=【ステップ4-2でコピーしたSecret】

# LIFF設定
NEXT_PUBLIC_LIFF_ID_INITIAL_LINK=【LIFF 1のID】
NEXT_PUBLIC_LIFF_ID_QR_CODE=【LIFF 2のID】
NEXT_PUBLIC_LIFF_ID_FAMILY_REGISTER=【LIFF 3のID】
NEXT_PUBLIC_LIFF_ID_APPOINTMENTS=【LIFF 4のID】
NEXT_PUBLIC_LIFF_ID_WEB_BOOKING=【LIFF 5のID】
```

**実際の例**:
```bash
# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lL...
LINE_CHANNEL_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

# LIFF設定
NEXT_PUBLIC_LIFF_ID_INITIAL_LINK=1234567890-abcdefgh
NEXT_PUBLIC_LIFF_ID_QR_CODE=1234567890-xxxxxxxx
NEXT_PUBLIC_LIFF_ID_FAMILY_REGISTER=1234567890-yyyyyyyy
NEXT_PUBLIC_LIFF_ID_APPOINTMENTS=1234567890-zzzzzzzz
NEXT_PUBLIC_LIFF_ID_WEB_BOOKING=1234567890-wwwwwwww
```

4. ファイルを保存

### 6-3. 開発サーバーを再起動

ターミナルで：
```bash
# サーバーを停止（Ctrl + C）
# 再起動
npm run dev
```

---

## ステップ7: リッチメニューを反映（2分）

### 7-1. LINE設定画面を開く

1. D-MAXにログイン
2. 「設定」→「LINE設定」タブをクリック

### 7-2. リッチメニューを確認

「リッチメニュー設定」セクションで：
- デザインプレビューを確認
- ボタン配置を確認

### 7-3. リッチメニューを反映

1. 「リッチメニューを反映」ボタンをクリック
2. ✅「リッチメニューを反映しました」と表示されればOK

❌ エラーが出た場合：
- アクセストークンが正しいか確認
- 開発サーバーが起動しているか確認

---

## ステップ8: 友だち追加してテスト（3分）

### 8-1. QRコードを取得

1. LINE Developers Console に戻る
2. 作成したチャネルの「Messaging API設定」タブ
3. 「Bot情報」セクションの QRコード を表示

### 8-2. スマホで友だち追加

1. スマホのLINEアプリを開く
2. 友だち追加 → QRコード
3. パソコン画面のQRコードを読み取る
4. 「追加」をタップ

### 8-3. リッチメニューを確認

友だち追加後、トーク画面の下部にリッチメニューが表示されます：

```
┌──────┬──────┬──────┐
│      │      │      │
│Web   │ QR   │予約  │
│サイト│コード│確認  │
├──────┼──────┴──────┤
│      │             │
│家族  │  予約を取る  │
│登録  │             │
├──────┤             │
│      │             │
│お問  │             │
│合せ  │             │
└──────┴─────────────┘
```

✅ リッチメニューが表示されていればOK！

---

## 完了！次は患者さんに案内

### 患者さんへの案内文（例）

```
【LINE公式アカウント 開始のお知らせ】

〇〇歯科クリニックの公式LINEアカウントができました！

＜できること＞
・診察券をスマホで表示（QRコード）
・予約の確認・変更・キャンセル
・ご家族全員の診察券を管理
・LINE から簡単にWeb予約

＜ご利用方法＞
1. QRコード を読み取って友だち追加
   [QRコード画像]

2. 受付で「招待コード」をもらう

3. LINE のメニューから「初回登録」をタップ

4. 招待コードと生年月日を入力

5. 完了！

ご不明な点はスタッフまでお気軽にお尋ねください。
```

---

## トラブルシューティング

### Q1: リッチメニューが表示されない

**確認項目**:
- ✅ 友だち追加したか
- ✅ トーク画面を開いているか（ホームタブではない）
- ✅ 「リッチメニューを反映」を実行したか

**対処法**:
1. 一度友だちを削除
2. もう一度QRコードから友だち追加
3. それでもダメなら、LINE Developers でリッチメニューを確認

### Q2: 「LIFF初期化に失敗しました」と表示される

**確認項目**:
- ✅ LIFF ID が正しいか
- ✅ エンドポイントURLが正しいか（HTTPSか）
- ✅ 開発サーバーが起動しているか

**対処法**:
1. `.env.local` の LIFF ID を確認
2. LINE Developers の LIFF設定を確認
3. 開発サーバーを再起動

### Q3: 「Webhook検証に失敗しました」と表示される

**確認項目**:
- ✅ Webhook URLが正しいか
- ✅ サーバーが起動しているか
- ✅ ngrok が起動しているか（テスト環境の場合）

**対処法**:
1. Webhook URLを再確認
2. ブラウザで直接アクセスしてみる
3. Channel Secret が正しいか確認

---

## サポート

設定でお困りの場合は、以下の情報をご用意の上ご連絡ください：

1. エラーメッセージのスクリーンショット
2. どのステップで詰まったか
3. ブラウザのコンソールログ（F12キーで表示）

---

## おつかれさまでした！🎉

これで LINE連携システムの設定が完了しました。
患者さんに便利なサービスを提供できます！
