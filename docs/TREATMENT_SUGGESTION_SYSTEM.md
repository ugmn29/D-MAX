# 診療行為提案システム
## Treatment Suggestion System

電子カルテで診療行為を選択した際に、関連する処置や加算を自動的に提案するシステムです。

---

## 🎯 主な機能

### 1. **自動提案（Auto Suggestions）**
診療行為を選択すると、関連する処置が自動的に提案されます:

#### 📘 **加算の提案**
- **年齢加算**: 6歳未満の患者には乳幼児加算を自動提案
- **時間帯加算**: 休日・時間外・深夜診療の場合に該当加算を提案
- **訪問診療加算**: 訪問診療の場合に加算を提案

#### 📗 **関連処置の提案**
処置のカテゴリに基づいて、通常併用される処置を提案:
- **抜髄** → 根管貼薬、根管拡大、根管充填
- **抜歯** → 消炎処置、縫合、抜歯後処置
- **充填** → 窩洞形成、う蝕除去、知覚過敏処置
- **歯冠修復** → 形成、印象採得、装着

#### 📙 **次のステップの提案**
治療の流れに基づいて、次に行うべき処置を提案:
- 抜髄 → 根管充填
- 根管拡大 → 根管貼薬
- 印象採得 → 咬合採得、仮着
- 形成 → 印象採得、仮封

---

## 🛡️ バリデーション機能

### 包括ルールチェック
```
⚠️ 警告: [処置A]は[処置B]に包括されるため、別途算定できません
```
- 包括されている処置の追加をブロック
- 既に選択されている処置との包括関係を警告

### 背反ルールチェック
```
❌ エラー: [処置A]と[処置B]は同時算定できません
```
- **同時算定不可**: 同じタイミングで算定できない処置
- **同日算定不可**: 同じ日に算定できない処置
- **同月算定不可**: 同じ月に算定できない処置

### 算定回数制限チェック
```
⚠️ 警告: [処置A]は1ヶ月に1回までの制限があります
```
- 日、週、月、年単位での算定回数制限をチェック

---

## 💡 使い方

### 患者詳細ページ → 電子カルテタブ

1. **病名を選択**
   - 検索窓に病名を入力（例: う蝕、歯周炎）
   - 候補から選択して追加

2. **診療行為を選択**
   - 検索窓に処置名を入力（例: 抜髄、充填）
   - 候補から選択して追加

3. **関連処置の提案が表示される** 💡
   - 紫色のカードで提案が表示されます
   - 各提案には以下の情報が含まれます:
     - **タイプ**: 加算 / 関連処置 / 併用処置
     - **点数**: 追加される保険点数
     - **理由**: なぜ提案されているか
   - 「追加」ボタンで簡単に追加できます

4. **バリデーション警告の確認**
   - 包括・背反の警告が赤色または黄色で表示されます
   - 追加できない処置は自動的にブロックされます

---

## 📊 提案の種類とアイコン

| タイプ | アイコン色 | 説明 | 例 |
|--------|-----------|------|-----|
| **加算** | 🔵 青 | 基本処置に付随する加算 | 6歳未満乳幼児加算、休日加算 |
| **関連処置** | 🟢 緑 | カテゴリ内で併用される処置 | 抜髄→根管貼薬 |
| **併用処置** | 🟠 橙 | 治療の流れで次に行う処置 | 形成→印象採得 |

---

## 🔧 技術仕様

### データソース
- **診療行為マスター** (`treatment_codes`): 3,093件
  - 包括ルール: 7,778件
  - 背反ルール: 1,448件
  - 算定回数制限: 2,281件
  - PDF抽出ルール: 適用済み

### API
```typescript
// 関連処置を提案
suggestRelatedTreatments(
  selectedTreatmentCodes: string[],
  patientAge?: number,
  visitContext?: {...}
): Promise<TreatmentSuggestion[]>

// 処置追加のバリデーション
validateTreatmentAddition(
  newTreatmentCode: string,
  existingTreatmentCodes: string[]
): Promise<ValidationResult>
```

### 提案ロジック

1. **メタデータベース提案**
   - `metadata.addition_rules` から加算を抽出
   - 患者年齢・診療時間に基づいてフィルタリング

2. **カテゴリベース提案**
   - 診療行為コードの先頭3桁でカテゴリを判定
   - カテゴリごとの関連キーワードで検索

3. **シーケンシャル提案**
   - 処置名のパターンマッチング
   - 治療の流れに基づいた次ステップを提案

---

## 📈 実装済み機能

- ✅ 自動提案システム
- ✅ 包括ルールバリデーション
- ✅ 背反ルールバリデーション
- ✅ 加算の自動提案（年齢・時間帯）
- ✅ カテゴリベースの関連処置提案
- ✅ 治療フローベースの次ステップ提案
- ✅ リアルタイム点数計算
- ✅ 提案UIの統合

---

## 🚀 今後の拡張可能性

### 機械学習による提案精度向上
- 過去の診療データから学習
- 医師ごとの診療パターンを分析
- 病名と処置の組み合わせを最適化

### 算定回数制限の自動チェック
- 過去の診療履歴との照合
- カレンダーベースの制限チェック
- 自動アラート機能

### テンプレート機能
- よく使う処置セットを保存
- 病名別の標準処置パターン
- 院内プロトコルの登録

---

## 📝 使用例

### 例1: 抜髄処置の場合

```
選択: 抜髄（単根管） 234点

💡 提案:
  🟢 根管貼薬 (33点)
     理由: 抜髄処置に続いて通常行われる処置

  🟢 根管拡大 (XXX点)
     理由: 抜髄処置に続いて通常行われる処置

  🔵 6歳未満乳幼児加算 (+47点)
     理由: 患者が5歳のため、6歳未満乳幼児加算(+20%)が適用できます
```

### 例2: 抜歯処置の場合

```
選択: 抜歯（前歯） 160点

💡 提案:
  🟢 消炎処置 (XXX点)
     理由: 抜歯に関連する処置

  🟢 縫合 (XXX点)
     理由: 抜歯に関連する処置
```

---

## 🎨 UI/UX

### 提案カード
- **紫色の背景**: 注目度を高める
- **タイプ別バッジ**: 一目で種類を判別
- **点数表示**: 追加される点数を明示
- **理由説明**: なぜ提案されているかを明確に
- **ワンクリック追加**: スムーズな操作性

### エラー表示
- **赤色アラート**: 包括・背反エラー
- **黄色警告**: 制限に関する注意
- **自動消去**: 5秒後に自動的に消える

---

## 🧪 テスト

テストスクリプトで機能を確認できます:

```bash
npx tsx scripts/test-suggestion-system.ts
```

実際の動作確認:
```
http://localhost:3000/patients/9f0e47ed-a900-4732-93b9-9370597f4d32
```

---

## 📚 関連ファイル

### APIレイヤー
- `lib/api/treatment-suggestions.ts` - 提案システムのコアロジック
- `lib/api/emr.ts` - EMR基本API

### UIコンポーネント
- `components/patients/emr-tab.tsx` - 電子カルテタブ（提案UI統合済み）

### データベース
- `treatment_codes` テーブル - 診療行為マスター
- `disease_codes` テーブル - 病名マスター

### スクリプト
- `scripts/import-treatment-codes.ts` - 診療行為マスターインポート
- `scripts/import-disease-codes.ts` - 病名マスターインポート
- `scripts/test-suggestion-system.ts` - 提案システムテスト

---

## ✨ まとめ

診療行為提案システムは、保険診療のルールに基づいて:
- ✅ 適切な処置を自動提案
- ✅ 不適切な処置をブロック
- ✅ 加算を自動計算
- ✅ 点数計算をリアルタイム表示

これにより、レセプト請求の精度が向上し、診療の効率化を実現します。
