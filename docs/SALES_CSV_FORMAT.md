# 売上データ CSV インポートフォーマット

## 概要
電子カルテシステムから売上データをインポートするための CSV フォーマット仕様です。

## 標準フォーマット（推奨）

### 必須カラム
| カラム名 | 説明 | 形式 | 例 |
|---------|------|------|-----|
| receipt_number | レセプト番号・会計番号 | 文字列 | `REC-20250111-001` |
| treatment_date | 診療日 | YYYY-MM-DD | `2025-01-11` |
| patient_id | 患者ID（カルテ番号） | 文字列 | `P-00001` |
| total_amount | 合計金額（円） | 整数 | `15000` |

### 推奨カラム
| カラム名 | 説明 | 形式 | 例 |
|---------|------|------|-----|
| patient_name | 患者氏名 | 文字列 | `山田太郎` |
| insurance_type | 保険種別 | 文字列 | `社保`, `国保`, `後期高齢`, `自費` |
| insurance_points | 保険点数 | 整数 | `1500` |
| insurance_amount | 保険請求額 | 整数 | `15000` |
| patient_copay | 患者負担額（保険診療分） | 整数 | `4500` |
| self_pay_amount | 自費診療額 | 整数 | `50000` |
| payment_method | 支払方法 | 文字列 | `現金`, `クレジットカード`, `QR決済` |
| staff_name | 担当スタッフ名 | 文字列 | `佐藤花子` |
| treatment_menu | 診療メニュー | 文字列 | `う蝕処置`, `抜歯`, `クリーニング` |
| treatment_codes | 診療行為コード | 文字列（カンマ区切り） | `101010,102020,103030` |
| notes | 備考 | 文字列 | `初診` |

### オプションカラム
| カラム名 | 説明 | 形式 |
|---------|------|------|
| sale_date | 会計日（診療日と異なる場合） | YYYY-MM-DD |
| appointment_id | 予約ID | 文字列 |
| category | 診療区分 | `insurance`, `self_pay` |

## CSVサンプル

### 基本フォーマット
```csv
receipt_number,treatment_date,patient_id,patient_name,insurance_type,insurance_points,patient_copay,self_pay_amount,total_amount,payment_method,staff_name,treatment_menu,notes
REC-20250111-001,2025-01-11,P-00001,山田太郎,社保,1500,4500,0,4500,現金,佐藤花子,う蝕処置,
REC-20250111-002,2025-01-11,P-00002,田中花子,国保,2000,6000,0,6000,クレジットカード,鈴木一郎,歯周治療,
REC-20250111-003,2025-01-11,P-00003,佐藤次郎,自費,0,0,80000,80000,クレジットカード,佐藤花子,インプラント,自費診療
```

### 詳細フォーマット（診療行為コード付き）
```csv
receipt_number,treatment_date,patient_id,patient_name,insurance_type,insurance_points,insurance_amount,patient_copay,self_pay_amount,total_amount,payment_method,staff_name,treatment_menu,treatment_codes,notes
REC-20250111-001,2025-01-11,P-00001,山田太郎,社保,1500,15000,4500,0,4500,現金,佐藤花子,う蝕処置,"101010,102020",初診
REC-20250111-002,2025-01-11,P-00002,田中花子,国保,2000,20000,6000,0,6000,クレジットカード,鈴木一郎,歯周治療,"103030,104040",
```

## 主要電子カルテシステム別フォーマット

### 1. Dental X 形式
```csv
カルテ番号,患者氏名,診療日,保険種別,点数,請求額,患者負担,自費額,合計,支払方法,担当者,診療内容
P-00001,山田太郎,2025/01/11,社保,1500,15000,4500,0,4500,現金,佐藤花子,う蝕処置
```

### 2. デンタルマップ形式
```csv
会計番号,診療日,患者ID,患者名,保険区分,点数,保険額,負担金,自費,合計額,決済方法,Dr,備考
A001,2025-01-11,P-00001,山田太郎,1,1500,15000,4500,0,4500,1,佐藤,
```

### 3. アポツール形式
```csv
レセプト番号,診療年月日,患者番号,氏名,保険,点数,請求,窓口,自由,総額,支払,スタッフ,メモ
REC001,20250111,P-00001,山田太郎,社保,1500,15000,4500,0,4500,現金,佐藤花子,
```

### 4. 一般的な歯科レセコン形式（コード体系）
⚠️ **注意**: この形式は一般的な歯科レセコンのコード体系例です。
実際のフォーマットは電子カルテによって異なる場合があります。

```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00001,山田太郎,2025/01/11,1,1500,15000,4500,0,4500,1,佐藤,初診・う蝕処置,
00002,田中花子,2025/01/11,2,2000,20000,6000,0,6000,2,鈴木,歯周治療,
00003,佐藤次郎,2025/01/11,9,0,0,80000,80000,80000,2,佐藤,インプラント,自費
```

**保険種別コード（一般的な体系）**:
- 1: 社保（社会保険）
- 2: 国保（国民健康保険）
- 3: 後期高齢者医療
- 4: 労災保険
- 5: 公費負担医療
- 9: 自費診療

**入金方法コード（一般的な体系）**:
- 1: 現金
- 2: クレジットカード
- 3: QR決済
- 4: 未収
- 5: 銀行振込

⚠️ **お使いの電子カルテのコード体系は異なる可能性があります。**

### 5. OPERAS Cloud形式
```csv
会計ID,診療日,患者ID,患者名,保険区分,点数,保険請求額,患者負担額,自費額,総額,決済,担当者,備考
ACC001,2025-01-11,P-00001,山田太郎,社保,1500,15000,4500,0,4500,現金,佐藤花子,初診
```

## インポート処理仕様

### 1. 患者マッチング
以下の順序で既存患者とマッチング：
1. `patient_id`（カルテ番号）が一致
2. `patient_name`と`treatment_date`が一致
3. マッチしない場合は新規患者として扱うか、エラーとして報告

### 2. スタッフマッチング
- `staff_name`から既存スタッフを検索
- 見つからない場合は未割り当て（NULL）

### 3. 診療メニューマッチング
- `treatment_menu`から既存の診療メニューを検索
- 見つからない場合は未割り当て（NULL）

### 4. データ変換
- 日付形式の自動変換（`2025/01/11`, `20250111`, `2025-01-11`など）
- 数値形式の自動変換（カンマ付き数値`1,500`→`1500`）
- 保険種別の正規化（`社保`→`insurance`, `自費`→`self_pay`など）

### 5. バリデーション
- 必須項目のチェック
- 日付の妥当性チェック
- 金額の正数チェック
- 重複チェック（同一`receipt_number`の重複インポート防止）

## エラーハンドリング

### エラー種別
1. **必須項目エラー**: 必須カラムが欠落
2. **フォーマットエラー**: 日付や数値の形式不正
3. **参照エラー**: 患者IDが見つからない
4. **重複エラー**: 既に同じレセプト番号が存在

### エラーログ
- エラーが発生した行番号
- エラーメッセージ
- 問題のあるデータ
- 修正方法の提案

## API エンドポイント

### POST /api/sales/import
CSV ファイルをアップロードして売上データをインポート

**リクエスト:**
```typescript
FormData {
  file: File, // CSV ファイル
  clinic_id: string,
  encoding: 'utf-8' | 'shift-jis', // 文字エンコーディング
  skip_errors: boolean, // エラー行をスキップして続行
  dry_run: boolean // テスト実行（実際のインポートは行わない）
}
```

**レスポンス:**
```json
{
  "success": true,
  "import_id": "uuid",
  "total_records": 100,
  "success_records": 95,
  "failed_records": 5,
  "errors": [
    {
      "row": 10,
      "error": "患者IDが見つかりません",
      "data": { "patient_id": "P-99999" }
    }
  ]
}
```

### GET /api/sales/import-history
インポート履歴の取得

### GET /api/sales/template
CSV テンプレートファイルのダウンロード
