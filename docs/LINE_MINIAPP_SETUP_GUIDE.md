# LINEミニアプリ 設定手順（2025年版）

## 📱 LINEミニアプリとは

LIFFの後継として、より高機能になったLINE上で動作するWebアプリケーションです。
設定方法は従来のLIFFとほぼ同じで、D-MAXの実装もそのまま動作します。

**所要時間**: 約30分

---

## 事前準備

### 必要なもの
1. ✅ LINEアカウント
2. ✅ パソコン（設定作業用）
3. ✅ スマートフォン（テスト用）
4. ✅ メールアドレス

### D-MAXの準備
- ✅ 開発サーバーが起動中
- ✅ ngrok が起動中（テスト環境の場合）

---

## ステップ1: LINE Developers にログイン（3分）

### 1-1. LINE Developersを開く

ブラウザで以下のURLにアクセス：
```
https://developers.line.biz/console/
```

### 1-2. ログイン

1. 「LINEアカウントでログイン」をクリック
2. 普段使っているLINEのメールアドレスとパスワードを入力
3. 「ログイン」をクリック

---

## ステップ2: プロバイダーとチャネルを作成（5分）

### 2-1. プロバイダーを作成（初回のみ）

プロバイダーがない場合：

1. 「新規プロバイダー作成」ボタンをクリック
2. プロバイダー名を入力
   ```
   例: 山田歯科クリニック
   ```
3. 「作成」をクリック

### 2-2. Messaging APIチャネルを作成（初回のみ）

1. 作成したプロバイダーを選択
2. 「新規チャネル作成」→「Messaging API」を選択
3. チャネル情報を入力：

   **チャネル名**:
   ```
   山田歯科クリニック
   ```

   **チャネル説明**:
   ```
   山田歯科クリニックの公式LINEアカウントです
   ```

   **大業種**: 医療・福祉

   **小業種**: 病院・診療所

4. 利用規約に同意して「作成」をクリック

---

## ステップ3: 基本設定（5分）

### 3-1. チャネルアクセストークンを発行

1. 作成したチャネルを選択
2. 「Messaging API設定」タブをクリック
3. 「チャネルアクセストークン」セクションまでスクロール
4. 「発行」ボタンをクリック
5. 表示されたトークンを**コピー**

```
例: eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczovL...
```

📝 **メモ帳に保存**してください（後で使います）

### 3-2. Channel Secretを取得

1. 「チャネル基本設定」タブをクリック
2. 「Channel Secret」を見つける
3. 表示された値を**コピー**

```
例: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

📝 **メモ帳に保存**してください

### 3-3. Webhook URLを設定

1. 「Messaging API設定」タブに戻る
2. 「Webhook設定」セクションで「編集」をクリック
3. Webhook URLを入力：

   **テスト環境**:
   ```
   https://lofty-herlinda-compulsively.ngrok-free.dev/api/line/webhook
   ```

   **本番環境**:
   ```
   https://あなたのドメイン.com/api/line/webhook
   ```

4. 「Webhookの利用」を**オン**にする
5. 「検証」ボタンをクリック
6. ✅「成功しました」と表示されればOK

### 3-4. 応答メッセージをオフ

1. 「LINE公式アカウント機能」セクションを見つける
2. 「応答メッセージ」を**オフ**にする

⚠️ **重要**: オンのままだと自動返信が邪魔します

---

## ステップ4: LINEミニアプリを作成（15分）

ここが**従来のLIFFと少し違う**部分です。

### 4-1. LINEミニアプリタブを開く

1. チャネル画面で以下のタブを探します：

   **パターンA（新しいUI）**:
   ```
   「LINEミニアプリ」タブ ← これをクリック
   ```

   **パターンB（従来のUI）**:
   ```
   「LIFF」タブ ← こちらをクリック
   ```

   💡 **どちらでもOK**です。設定内容は同じです。

2. 「追加」または「作成」ボタンをクリック

---

### 4-2. ミニアプリ 1個目: 初回連携

#### 基本情報

**ミニアプリ名**（またはLIFFアプリ名）:
```
山田歯科クリニック - 初回連携
```

**説明**（任意）:
```
患者さんのLINEアカウントとクリニックの患者情報を連携します
```

#### 表示設定

**ビューサイズ**（またはサイズ）:
```
Tall
```

選択肢：
- ❌ Compact（小さい）
- ✅ **Tall（中くらい）← これを選択**
- ❌ Full（全画面）

#### エンドポイント設定

**サービスURL**（またはエンドポイントURL）:

**テスト環境**:
```
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/initial-link
```

**本番環境**:
```
https://あなたのドメイン.com/liff/initial-link
```

#### 権限設定

**Scope**（チェックボックス）:
- ✅ **profile**（必須）
- ✅ **openid**（必須）
- ☐ chat_message.write（不要）
- ☐ その他（不要）

#### その他の設定

**ボットリンク機能**:
```
On (Aggressive)
```

#### 作成実行

1. すべて入力したら「追加」または「作成」ボタンをクリック
2. ✅ 作成完了

#### ミニアプリIDをコピー

作成後、以下のような画面が表示されます：

```
┌─────────────────────────────────────┐
│ LINEミニアプリ詳細                   │
├─────────────────────────────────────┤
│ ミニアプリID: 1234567890-abcdefgh    │ ← これをコピー
│ ミニアプリ名: 山田歯科クリニック - 初回連携
│ ビューサイズ: Tall                  │
│ ...                                 │
└─────────────────────────────────────┘
```

📝 **メモ帳に「ミニアプリ1: 1234567890-abcdefgh」と保存**

---

### 4-3. ミニアプリ 2個目: QRコード表示

もう一度「追加」ボタンをクリックして、以下を入力：

#### 基本情報

**ミニアプリ名**:
```
山田歯科クリニック - QRコード
```

**説明**（任意）:
```
受付で提示する診察券QRコードを表示します
```

#### 表示設定

**ビューサイズ**:
```
Tall
```

#### エンドポイント設定

**サービスURL**:

**テスト環境**:
```
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/qr-code
```

**本番環境**:
```
https://あなたのドメイン.com/liff/qr-code
```

#### 権限設定

**Scope**:
- ✅ profile
- ✅ openid

#### その他

**ボットリンク機能**: On (Aggressive)

#### 作成してIDをコピー

📝 **メモ帳に「ミニアプリ2: 1234567890-xxxxxxxx」と保存**

---

### 4-4. ミニアプリ 3個目: 家族登録

#### 基本情報

**ミニアプリ名**:
```
山田歯科クリニック - 家族登録
```

**説明**:
```
ご家族の診察券を追加登録します
```

#### 表示設定

**ビューサイズ**:
```
Tall
```

#### エンドポイント設定

**サービスURL**:

**テスト環境**:
```
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/family-register
```

**本番環境**:
```
https://あなたのドメイン.com/liff/family-register
```

#### 権限設定

**Scope**:
- ✅ profile
- ✅ openid

#### その他

**ボットリンク機能**: On (Aggressive)

#### IDをコピー

📝 **メモ帳に「ミニアプリ3: 1234567890-yyyyyyyy」と保存**

---

### 4-5. ミニアプリ 4個目: 予約確認

#### 基本情報

**ミニアプリ名**:
```
山田歯科クリニック - 予約確認
```

**説明**:
```
予約の確認・変更・キャンセルができます
```

#### 表示設定

**ビューサイズ**:
```
Full ← ここだけ違います！
```

⚠️ **注意**: 予約確認は全画面表示なので**Full**を選択

#### エンドポイント設定

**サービスURL**:

**テスト環境**:
```
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/appointments
```

**本番環境**:
```
https://あなたのドメイン.com/liff/appointments
```

#### 権限設定

**Scope**:
- ✅ profile
- ✅ openid

#### その他

**ボットリンク機能**: On (Aggressive)

#### IDをコピー

📝 **メモ帳に「ミニアプリ4: 1234567890-zzzzzzzz」と保存**

---

### 4-6. ミニアプリ 5個目: Web予約

#### 基本情報

**ミニアプリ名**:
```
山田歯科クリニック - Web予約
```

**説明**:
```
LINEから簡単にWeb予約ができます
```

#### 表示設定

**ビューサイズ**:
```
Full ← ここも全画面
```

#### エンドポイント設定

**サービスURL**:

**テスト環境**:
```
https://lofty-herlinda-compulsively.ngrok-free.dev/liff/web-booking
```

**本番環境**:
```
https://あなたのドメイン.com/liff/web-booking
```

#### 権限設定

**Scope**:
- ✅ profile
- ✅ openid

#### その他

**ボットリンク機能**: On (Aggressive)

#### IDをコピー

📝 **メモ帳に「ミニアプリ5: 1234567890-wwwwwwww」と保存**

---

### ✅ 5個のミニアプリ作成完了チェック

メモ帳に以下が揃っているか確認：

```
【LINE連携設定メモ】

■ チャネルアクセストークン
eyJhbGciOiJIUzI1NiJ9...

■ Channel Secret
a1b2c3d4e5f6g7h8i9j0...

■ ミニアプリID（またはLIFF ID）
ミニアプリ1 (初回連携): 1234567890-abcdefgh
ミニアプリ2 (QRコード): 1234567890-xxxxxxxx
ミニアプリ3 (家族登録): 1234567890-yyyyyyyy
ミニアプリ4 (予約確認): 1234567890-zzzzzzzz
ミニアプリ5 (Web予約): 1234567890-wwwwwwww
```

---

## ステップ5: D-MAXに設定を登録（3分）

### 5-1. .env.local ファイルを編集

D-MAXのプロジェクトフォルダで `.env.local` ファイルを開き、以下を追加：

```bash
# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=【ステップ3-1でコピーしたトークン】
LINE_CHANNEL_SECRET=【ステップ3-2でコピーしたSecret】

# LINEミニアプリID（LIFF IDと同じ変数名でOK）
NEXT_PUBLIC_LIFF_ID_INITIAL_LINK=【ミニアプリ1のID】
NEXT_PUBLIC_LIFF_ID_QR_CODE=【ミニアプリ2のID】
NEXT_PUBLIC_LIFF_ID_FAMILY_REGISTER=【ミニアプリ3のID】
NEXT_PUBLIC_LIFF_ID_APPOINTMENTS=【ミニアプリ4のID】
NEXT_PUBLIC_LIFF_ID_WEB_BOOKING=【ミニアプリ5のID】
```

**実際の例**:
```bash
# LINE設定
LINE_CHANNEL_ACCESS_TOKEN=eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczovL2FjY2Vzcy5saW5lLm1lL...
LINE_CHANNEL_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

# LINEミニアプリID
NEXT_PUBLIC_LIFF_ID_INITIAL_LINK=1234567890-abcdefgh
NEXT_PUBLIC_LIFF_ID_QR_CODE=1234567890-xxxxxxxx
NEXT_PUBLIC_LIFF_ID_FAMILY_REGISTER=1234567890-yyyyyyyy
NEXT_PUBLIC_LIFF_ID_APPOINTMENTS=1234567890-zzzzzzzz
NEXT_PUBLIC_LIFF_ID_WEB_BOOKING=1234567890-wwwwwwww
```

### 5-2. 保存して開発サーバーを再起動

ターミナルで：

```bash
# Ctrl+C でサーバーを停止

# 再起動
npm run dev
```

✅ サーバーが起動したら設定完了

---

## ステップ6: リッチメニューを反映（2分）

### 6-1. D-MAXの設定画面を開く

ブラウザで：
```
http://localhost:3000/settings
```

### 6-2. LINE設定タブを開く

1. 左メニューの「LINE設定」をクリック
2. 下にスクロールして「リッチメニュー設定」を見つける

### 6-3. リッチメニューを反映

1. デザインプレビューを確認
2. 「リッチメニューを反映」ボタンをクリック
3. ✅「リッチメニューを反映しました」と表示されればOK

---

## ステップ7: テスト（5分）

### 7-1. 友だち追加用QRコードを取得

1. LINE Developers Console に戻る
2. チャネルの「Messaging API設定」タブ
3. 「Bot情報」セクションのQRコードを表示

### 7-2. スマホで友だち追加

1. スマホのLINEアプリを開く
2. 友だち追加 → QRコード
3. パソコン画面のQRコードをスキャン
4. 「追加」をタップ

### 7-3. リッチメニューを確認

トーク画面の下部にリッチメニューが表示されます：

```
┌──────┬──────┬──────┐
│      │      │      │
│Web   │ QR   │予約  │
│サイト│コード│確認  │
├──────┼──────┴──────┤
│      │             │
│家族  │  予約を取る  │
│登録  │             │
├──────┤             │
│      │             │
│お問  │             │
│合せ  │             │
└──────┴─────────────┘
```

### 7-4. ミニアプリを起動してテスト

1. リッチメニューの「QRコード」をタップ
2. LINEミニアプリが起動する
3. ✅ D-MAXのQRコード画面が表示されればOK

⚠️ **初回は患者連携が必要**なので、まず「初回連携」から始めてください。

---

## 📊 設定内容の一覧表

| 項目 | ミニアプリ1 | ミニアプリ2 | ミニアプリ3 | ミニアプリ4 | ミニアプリ5 |
|------|----------|----------|----------|----------|----------|
| **名前** | 初回連携 | QRコード | 家族登録 | 予約確認 | Web予約 |
| **サイズ** | Tall | Tall | Tall | **Full** | **Full** |
| **URL** | `/liff/initial-link` | `/liff/qr-code` | `/liff/family-register` | `/liff/appointments` | `/liff/web-booking` |
| **Scope** | profile, openid | profile, openid | profile, openid | profile, openid | profile, openid |
| **ボットリンク** | On | On | On | On | On |

---

## 🔍 LIFFとの違い

### タブ名
- **LIFF**: 「LIFF」タブ
- **ミニアプリ**: 「LINEミニアプリ」タブ

### 用語
- **LIFF**: LIFFアプリ名、LIFF ID、エンドポイントURL
- **ミニアプリ**: ミニアプリ名、ミニアプリID、サービスURL

### 機能
- **LIFF**: 基本機能のみ
- **ミニアプリ**: オフライン対応、プッシュ通知など（将来的に）

### D-MAXでの扱い
- **どちらも同じ**: 環境変数名、コード、APIはすべて同じ

---

## ❓ よくある質問

### Q1: 「LIFFタブ」しかないんですが？
**A**: それでOKです！
- 「LIFF」タブから作成してください
- 発行されるIDは同じ形式です
- D-MAXのコードはそのまま動作します

### Q2: 「LINEミニアプリ」と「LIFF」両方のタブがあります
**A**: どちらから作成してもOKです！
- 「LINEミニアプリ」タブを推奨（新しいUI）
- 設定内容は同じです

### Q3: IDの形式は同じ？
**A**: はい、同じです
```
LIFF ID: 1234567890-abcdefgh
ミニアプリID: 1234567890-abcdefgh
（同じ形式）
```

### Q4: .env.local の変数名は変える必要がある？
**A**: いいえ、そのままでOKです
```bash
# LIFFでもミニアプリでもこのまま
NEXT_PUBLIC_LIFF_ID_INITIAL_LINK=1234567890-abcdefgh
```

### Q5: 既存のLIFFアプリはどうなる？
**A**: そのまま使えます
- 自動的にミニアプリに移行される可能性
- 手動移行が必要な場合はLINEから案内あり

---

## 🎉 設定完了！

これでLINEミニアプリの設定が完了しました。

次は患者さんに案内して、実際に使ってもらいましょう！

---

## 📞 サポート

設定でお困りの場合：

1. エラーメッセージのスクリーンショットを撮る
2. どのステップで詰まったか確認
3. ブラウザのコンソール（F12）でエラーを確認

よくあるエラーと解決方法は [LINE_TESTING_GUIDE.md](LINE_TESTING_GUIDE.md) のトラブルシューティングを参照してください。
