# 診療行為の関連処置提案機能・包括チェック機能

## 概要

電子カルテシステムに以下2つの機能を追加しました：

1. **関連処置の提案機能**: 診療行為を選択した際に、関連する処置を自動的に提案
2. **包括チェック機能**: 診療行為が他の処置に包括されている場合に警告を表示

## 機能詳細

### 1. 関連処置の提案機能

診療行為を選択すると、関連する処置が自動的に提案されます。

#### 例

- **CR充填を選択** → 「浸潤麻酔」「形成」を提案
- **抜髄を選択** → 「浸潤麻酔」「根管長測定」「根管貼薬」を提案
- **SRPを選択** → 「浸潤麻酔」「歯科衛生実地指導」を提案
- **抜歯を選択** → 「浸潤麻酔」「伝達麻酔」を提案

#### UI表示

```
┌─────────────────────────────────────────────┐
│ 💡 関連処置の提案                           │
│                                             │
│ CR充填には通常、麻酔と形成が必要です        │
│                                             │
│ [+ 浸潤麻酔] [+ 形成]                       │
└─────────────────────────────────────────────┘
```

提案されたボタンをクリックすると、その処置が自動的に検索・追加されます。

### 2. 包括チェック機能

診療行為を選択した際に、その処置が他の処置に包括されている場合に警告を表示します。

#### 例

**既に「充填」が選択されている状態で「形成」を追加しようとした場合:**

```
┌─────────────────────────────────────────────┐
│ ⚠️ 包括警告                                 │
│                                             │
│ 形成は充填・修復処置に包括されています      │
│ （既に「う蝕歯即時充填形成」が選択されて    │
│  います）                                   │
└─────────────────────────────────────────────┘
```

**逆のケース - 既に「形成」が選択されている状態で「充填」を追加した場合:**

```
┌─────────────────────────────────────────────┐
│ 💡 「形成」は「う蝕歯即時充填形成」に包括   │
│    されているため、別途算定できません       │
└─────────────────────────────────────────────┘
```

### 3. 背反チェック機能（同時算定不可）

同時に算定できない診療行為を選択しようとした場合、エラーを表示して追加をブロックします。

#### 例

**既に「抜髄」が選択されている状態で「感染根管処置」を追加しようとした場合:**

```
┌─────────────────────────────────────────────┐
│ ❌ 背反エラー（同時算定不可）               │
│                                             │
│ 抜髄と感染根管処置は同日算定できません      │
│ （「抜髄（前歯）」が既に選択されています）  │
└─────────────────────────────────────────────┘
```

処置は追加されず、エラーメッセージのみ表示されます。

## 実装詳細

### ファイル構成

```
lib/validation/treatment-suggestions.ts  # 提案・検証ロジック
components/patients/emr-tab.tsx          # UI実装
```

### 主要な関数

#### `validateTreatmentSelection()`

診療行為選択時の総合的なバリデーション関数

```typescript
export function validateTreatmentSelection(
  newTreatment: TreatmentCode,
  alreadySelectedTreatments: TreatmentCode[]
): {
  canAdd: boolean              // 追加可否
  suggestions: string[]        // 関連処置の提案
  inclusionWarnings: string[]  // 包括警告
  exclusionErrors: string[]    // 背反エラー
  suggestionReason: string     // 提案理由
}
```

#### `getSuggestedTreatments()`

選択された診療行為に基づいて関連処置を提案

```typescript
export function getSuggestedTreatments(
  selectedTreatment: TreatmentCode,
  alreadySelectedTreatments: TreatmentCode[]
): {
  suggestions: string[]
  reason: string
}
```

#### `checkInclusionViolations()`

包括ルールの違反をチェック

```typescript
export function checkInclusionViolations(
  newTreatment: TreatmentCode,
  alreadySelectedTreatments: TreatmentCode[]
): {
  isIncluded: boolean
  warnings: string[]
}
```

#### `checkExclusionViolations()`

背反ルール（同時算定不可）の違反をチェック

```typescript
export function checkExclusionViolations(
  newTreatment: TreatmentCode,
  alreadySelectedTreatments: TreatmentCode[]
): {
  hasConflict: boolean
  errors: string[]
}
```

## データ構造

### 関連処置マッピング

```typescript
const TREATMENT_ASSOCIATIONS = {
  '充填': {
    suggestedTreatments: ['浸潤麻酔', '形成'],
    reason: '充填処置には通常、麻酔と形成が必要です'
  },
  'CR': {
    suggestedTreatments: ['浸潤麻酔', '形成'],
    reason: 'CR充填には通常、麻酔と形成が必要です'
  },
  '抜髄': {
    suggestedTreatments: ['浸潤麻酔', '根管長測定', '根管貼薬'],
    reason: '抜髄処置には麻酔と根管処置が必要です'
  },
  // ... 他15種類以上
}
```

### 包括ルール

```typescript
const INCLUSION_RULES = {
  '形成': {
    includedIn: ['充填', 'CR', 'レジン充填', 'インレー', 'クラウン', 'ブリッジ'],
    explanation: '形成は充填・修復処置に包括されています'
  },
  '根管長測定': {
    includedIn: ['抜髄', '感染根管処置'],
    explanation: '根管長測定は根管治療に包括されています'
  },
  // ... 他5種類以上
}
```

### 背反ルール

```typescript
const EXCLUSION_RULES = {
  '抜髄': {
    excludes: ['感染根管処置'],
    explanation: '抜髄と感染根管処置は同日算定できません'
  },
  'スケーリング': {
    excludes: ['SRP'],
    explanation: 'スケーリングとSRPは同月算定できません'
  },
  // ... 他3種類以上
}
```

## UI仕様

### 表示条件

- **関連処置の提案**: 診療行為追加時に提案がある場合に表示
- **包括警告**: 包括関係がある場合に表示（追加は可能）
- **背反エラー**: 同時算定不可の場合に表示（追加はブロック）

### 色分け

- **関連処置の提案**: 紫色の背景 (bg-purple-50)
- **包括警告**: オレンジ色の背景 (bg-orange-50)
- **背反エラー**: 赤色の背景 (bg-red-50)

### アイコン

- **関連処置の提案**: 💡 (Lightbulb)
- **包括警告**: ⚠️ (AlertCircle)
- **背反エラー**: ❌ (AlertCircle)

## テスト方法

### 1. 関連処置提案のテスト

1. 患者詳細ページを開く
2. 「電子カルテ」タブを選択
3. 診療行為検索で「CR充填」と入力
4. 候補から選択
5. → 紫色のカードに「浸潤麻酔」「形成」の提案が表示されることを確認
6. 「+ 浸潤麻酔」ボタンをクリック
7. → 浸潤麻酔が自動的に追加されることを確認

### 2. 包括チェックのテスト

1. 診療行為検索で「充填」と入力して選択
2. 次に「形成」と入力して選択しようとする
3. → オレンジ色の包括警告が表示されることを確認
4. 形成は追加されるが、警告メッセージが表示される

### 3. 背反チェックのテスト

1. 診療行為検索で「抜髄」と入力して選択
2. 次に「感染根管処置」と入力して選択しようとする
3. → 赤色の背反エラーが表示されることを確認
4. 感染根管処置は追加されない（ブロックされる）

## 今後の拡張予定

### データベース連携

現在はハードコードされた定義ですが、今後は以下のように拡張予定：

1. **包括ルールテーブル**: データベースに包括関係を格納
2. **背反ルールテーブル**: データベースに背反関係を格納
3. **使用頻度学習**: 実際の使用パターンから提案を学習

### 追加予定の機能

1. **算定回数制限チェック**: 月間・年間の算定回数をチェック
2. **年齢制限チェック**: 患者年齢による算定制限をチェック
3. **部位制限チェック**: 同一歯に対する処置制限をチェック
4. **保険種別チェック**: 保険種別による算定可否をチェック

## 参考資料

- 診療報酬点数表（令和6年4月版）
- 歯科診療報酬点数早見表
- 診療報酬請求書等の記載要領
