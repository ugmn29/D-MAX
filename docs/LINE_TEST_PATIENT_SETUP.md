# LINEテスト用患者データ作成ガイド

## 📋 概要

LINE連携のテストを行うために、テスト用の患者データを作成します。
実際の患者データと混在しても問題ないように、明確に区別できる設定にします。

---

## 🎯 テスト用患者の作成

### 方法1: D-MAX患者登録画面から作成

1. **D-MAXにログイン**
   - http://localhost:3000

2. **患者一覧ページを開く**
   - 左メニュー「患者」をクリック

3. **新規患者登録**
   - 「新規登録」ボタンをクリック

4. **テスト用患者情報を入力**

```
【テスト用患者1（あなた用）】
患者番号: 9999
姓: テスト
名: 太郎
フリガナ（姓）: テスト
フリガナ（名）: タロウ
生年月日: 1990/01/01
電話番号: 090-0000-0001
メールアドレス: test1@example.com
住所: 東京都テスト区テスト町1-1-1
LINE通知: 有効

【テスト用患者2（家族登録テスト用）】
患者番号: 9998
姓: テスト
名: 花子
フリガナ（姓）: テスト
フリガナ（名）: ハナコ
生年月日: 1992/05/15
電話番号: 090-0000-0002
メールアドレス: test2@example.com
住所: 東京都テスト区テスト町1-1-1
LINE通知: 有効
```

5. **テスト用予約を作成**

患者9999（テスト太郎）で以下の予約を作成:

```
【予約1: 未来の予約】
日時: 明日 14:00
診療内容: 定期検診
担当: 任意のスタッフ
ステータス: 予約済み

【予約2: 過去の予約】
日時: 1週間前 10:00
診療内容: クリーニング
担当: 任意のスタッフ
ステータス: 完了
```

---

## 📱 LINE連携テスト手順

### ステップ1: あなたのLINEで初回連携

1. **LINE公式アカウントを友だち追加**
   - QRコードまたは検索から友だち追加

2. **リッチメニューから任意のボタンをタップ**
   - 初回は自動的に初回連携画面が表示される

3. **テスト用患者で連携**
   ```
   患者番号: 9999
   生年月日: 1990/01/01
   ```

4. **連携成功を確認**
   - 「連携が完了しました」メッセージが表示される
   - 目的の画面（QRコードや予約確認）に遷移する

### ステップ2: 各機能をテスト

#### QRコードボタン
1. リッチメニュー「QRコード」をタップ
2. テスト太郎のQRコードが表示される
3. 患者番号「9999」が表示される

#### 予約確認ボタン
1. リッチメニュー「予約確認」をタップ
2. 明日14:00の予約が表示される
3. キャンセルボタンをテスト

#### 予約を取るボタン
1. リッチメニュー「予約を取る」をタップ
2. 患者情報が事前入力されている
   - 患者番号: 9999
   - 名前: テスト太郎
   - 生年月日: 1990/01/01
3. Web予約フォームで予約作成をテスト

#### 家族登録ボタン
1. リッチメニュー「家族登録」をタップ
2. 既存連携患者「テスト太郎」が表示される
3. 「家族を追加」をタップ
4. テスト用患者2で連携
   ```
   患者番号: 9998
   生年月日: 1992/05/15
   続柄: child（お子様）
   ```
5. 連携成功後、他のボタンで患者選択画面が表示される

### ステップ3: 家族登録後のテスト

1. **QRコードボタン**
   - 患者選択画面が表示される
   - テスト太郎 / テスト花子を切り替え
   - それぞれ異なるQRコードが表示される

2. **予約確認ボタン**
   - 患者選択画面が表示される
   - テスト太郎の予約のみ表示される
   - テスト花子は予約なし

3. **予約を取るボタン**
   - 患者選択画面が表示される
   - 選択した患者の情報が事前入力される

---

## 🔄 連携解除（リセット）方法

テストをやり直したい場合:

### 方法1: データベースから削除

```sql
-- LINE連携を削除
DELETE FROM line_patient_linkages
WHERE line_user_id = 'YOUR_LINE_USER_ID';

-- 再度初回連携からテスト可能
```

### 方法2: 別のLINEアカウントでテスト

- 家族や友人のLINEアカウントを使う
- 別のスマホでテストアカウントを作成

### 方法3: テスト患者を新規作成

```
患者番号: 9997, 9996, 9995...
```

---

## 👥 実際の患者さんとの区別

### テスト用患者の特徴

| 項目 | テスト用 | 本番用 |
|------|---------|--------|
| 患者番号 | 9999, 9998, 9997... | 0001, 0002, 0003... |
| 姓 | テスト | 実際の姓 |
| 電話 | 090-0000-XXXX | 実際の電話番号 |
| メール | test@example.com | 実際のメールアドレス |

### データベースでの確認

```sql
-- テスト用患者を確認
SELECT * FROM patients
WHERE patient_number >= 9990
ORDER BY patient_number DESC;

-- テスト用患者のLINE連携を確認
SELECT
  lpl.*,
  p.patient_number,
  p.last_name,
  p.first_name
FROM line_patient_linkages lpl
JOIN patients p ON lpl.patient_id = p.id
WHERE p.patient_number >= 9990;
```

---

## ✅ テストチェックリスト

### 初回連携
- [ ] 患者番号・生年月日で認証できる
- [ ] 連携成功メッセージが表示される
- [ ] 目的の画面に遷移する

### QRコード
- [ ] テスト太郎のQRコードが表示される
- [ ] 患者番号9999が表示される
- [ ] QRコード画像が生成される
- [ ] ダウンロードボタンが機能する

### 予約確認
- [ ] テスト太郎の予約が表示される
- [ ] 予約詳細が確認できる
- [ ] キャンセル機能が動作する

### Web予約
- [ ] 患者情報が事前入力される
- [ ] Web予約フォームが開く
- [ ] 予約作成が完了する

### 家族登録
- [ ] 既存連携患者が表示される
- [ ] テスト花子を追加登録できる
- [ ] 続柄を選択できる
- [ ] 追加後、患者選択画面が表示される

### パーソナライズ
- [ ] 1人連携時: 直接その患者の情報を表示
- [ ] 複数連携時: 患者選択画面を表示
- [ ] 患者ごとに異なるQRコードを表示
- [ ] 患者ごとに異なる予約を表示

---

## 🎉 テスト完了後

### 本番運用への移行

1. **テスト用患者はそのまま残す**
   - デモ・トレーニング用として活用

2. **実際の患者さんにLINE公式アカウントを案内**
   - QRコードを待合室に掲示
   - 初診時に案内
   - ホームページに掲載

3. **患者さんの初回連携をサポート**
   ```
   1. LINE公式アカウントを友だち追加
   2. リッチメニューから任意のボタンをタップ
   3. 患者番号と生年月日を入力
   4. 連携完了
   ```

4. **運用開始**
   - 予約通知の自動送信
   - リマインダー通知
   - Web予約の利用促進

---

## 📞 トラブルシューティング

### 「患者が見つかりません」エラー

**原因**: 患者番号または生年月日が間違っている

**解決策**:
1. D-MAXで患者情報を確認
2. 患者番号: 正しく入力されているか
3. 生年月日: YYYY/MM/DD 形式で入力

### QRコードが表示されない

**原因**: 患者IDの取得エラー

**解決策**:
1. ブラウザのコンソールでエラーを確認
2. 開発サーバーのログを確認
3. LINE User IDと患者が正しく連携されているか確認

### 予約が表示されない

**原因**: 予約データが存在しない

**解決策**:
1. D-MAXで予約を作成
2. 患者番号9999で予約を作成しているか確認
3. 予約ステータスが「予約済み」になっているか確認

---

## 📝 まとめ

テスト用患者データを使用することで:
- ✅ 実際の患者データに影響しない
- ✅ 安心してテストできる
- ✅ 何度でもやり直せる
- ✅ 本番運用と並行してテスト可能

患者番号9999番台をテスト用として確保し、実際の患者さんは0001番から採番することで、明確に区別できます。
