# 歯科電子カルテ 売上連携設定ガイド（一般的な手順）

## ⚠️ 重要な注意事項

**本ガイドについて**:
- 本ガイドは一般的な歯科レセコン・電子カルテのCSV連携手順の例です
- **実際の操作方法は製品によって大きく異なります**
- **必ずお使いの電子カルテのマニュアルを確認するか、メーカーサポートにお問い合わせください**

**対象製品例**:
- 株式会社ノーザ WiseStaff-F
- 株式会社オプテック Opt.One
- その他レセコン機能を持つ歯科電子カルテ

## 概要
歯科電子カルテから売上データをCSV形式でエクスポートし、当アプリに取り込む一般的な手順をご説明します。

---

## 手動連携の手順（月1回程度）

### Step 1: 電子カルテからCSVエクスポート

⚠️ **注意**: 以下は一般的な手順例です。実際のメニュー名や操作は製品によって異なります。

1. **電子カルテを起動**

2. **メニューから会計・売上関連の機能を選択**
   - 例: 「会計管理」→「売上集計」
   - 例: 「レセプト」→「会計データ出力」
   - ⚠️ お使いの製品のメニュー名を確認してください

3. **期間を指定**
   - 開始日: 2025/01/01
   - 終了日: 2025/01/31

4. **出力項目を選択**
   - ☑ 患者番号
   - ☑ 患者氏名
   - ☑ 診療日
   - ☑ 保険種別
   - ☑ 保険点数
   - ☑ 請求額
   - ☑ 入金額
   - ☑ 自費額
   - ☑ 合計金額
   - ☑ 入金方法
   - ☑ 担当Dr
   - ☑ 診療内容
   - ☑ 備考

5. **「CSV出力」ボタンをクリック**

6. **保存先を選択**
   - 例: `C:\Export\売上データ_2025年1月.csv`

### Step 2: 当アプリへのインポート

1. **分析ページを開く**
   - メニューから「分析」をクリック

2. **「売上分析」タブを選択**

3. **「売上データをインポート」ボタンをクリック**

4. **CSVファイルを選択**
   - 先ほどエクスポートしたファイルを選択

5. **インポート設定**
   - フォーマット: `一般的な歯科レセコン形式`または`カスタム`を選択
   - エンコーディング: `Shift-JIS`（日本語の場合） または `UTF-8`
   - ⚠️ 文字化けする場合は エンコーディングを変更してください
   - エラー処理: `エラー行をスキップして続行`にチェック（推奨）

6. **「インポート実行」ボタンをクリック**

7. **結果を確認**
   - 成功件数と失敗件数が表示されます
   - エラーがある場合は詳細を確認して修正

---

## 半自動連携の手順（毎日〜週1回）

ノーザ オプテックのタスクスケジューラ機能と、Dropbox/Google Driveを使った半自動化の方法です。

### Step 1: ノーザ オプテックで自動エクスポート設定

1. **「システム設定」→「自動処理設定」を開く**

2. **「新規タスク追加」をクリック**

3. **タスクの設定**
   ```
   タスク名: 売上CSV自動出力
   実行タイミング: 毎日 AM 1:00
   処理内容: CSV出力
   出力種類: 会計データ（前日分）
   出力先: C:\Dropbox\Dental\Sales\
   ファイル名形式: 売上_{YYYYMMDD}.csv
   ```

4. **出力項目テンプレートを作成**
   - 上記Step 1-4の項目を保存
   - テンプレート名: `売上データ標準出力`

5. **「保存」をクリック**

### Step 2: Dropboxの設定

1. **Dropboxデスクトップアプリをインストール**
   - https://www.dropbox.com/

2. **同期フォルダを設定**
   - `C:\Dropbox\Dental\Sales\`をDropboxと同期

3. **当アプリ側でDropbox連携を設定**（管理者が実装）
   - 設定 → 外部連携 → Dropbox連携を有効化
   - 監視フォルダ: `/Dental/Sales/`
   - 取り込み間隔: 1時間ごと

### 自動化後の運用

- **毎日**: ノーザが自動でCSV出力（AM 1:00）
- **毎日**: Dropboxが自動同期（常時）
- **毎日**: 当アプリが自動取り込み（AM 2:00）
- **毎朝**: 分析ページで前日の売上を確認

---

## CSVフォーマット詳細

### ノーザ オプテック標準フォーマット

```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
```

### 各カラムの説明

| カラム名 | 必須 | 形式 | 例 | 説明 |
|---------|------|------|-----|------|
| 患者番号 | ✅ | 数値 | `00001` | カルテ番号 |
| 患者氏名 | ⚠️ | 文字列 | `山田太郎` | マッチング用（任意） |
| 診療日 | ✅ | YYYY/MM/DD | `2025/01/11` | 診療を行った日 |
| 保険種別 | ✅ | コード | `1` | 1:社保, 2:国保, 3:後期, 9:自費 |
| 保険点数 | ⚠️ | 数値 | `1500` | 保険診療の点数 |
| 請求額 | ⚠️ | 数値 | `15000` | 保険請求総額（10倍） |
| 入金額 | ✅ | 数値 | `4500` | 患者から受け取った金額 |
| 自費額 | ⚠️ | 数値 | `80000` | 自費診療の金額 |
| 合計金額 | ✅ | 数値 | `4500` | 入金額+自費額 |
| 入金方法 | ⚠️ | コード | `1` | 1:現金, 2:カード, 3:QR, 4:未収 |
| 担当Dr | ⚠️ | 文字列 | `佐藤` | スタッフ名（自動マッチング） |
| 診療内容 | ⚠️ | 文字列 | `初診・う蝕処置` | メニュー名（自動マッチング） |
| 備考 | ⚠️ | 文字列 | `要フォロー` | 任意のメモ |

### 保険種別コード

| コード | 意味 |
|-------|------|
| 1 | 社会保険（社保） |
| 2 | 国民健康保険（国保） |
| 3 | 後期高齢者医療 |
| 4 | 労災保険 |
| 5 | 公費負担医療 |
| 9 | 自費診療 |

### 入金方法コード

| コード | 意味 |
|-------|------|
| 1 | 現金 |
| 2 | クレジットカード |
| 3 | QR決済（PayPay等） |
| 4 | 未収（後日支払） |
| 5 | 銀行振込 |

---

## よくあるエラーと対処法

### エラー1: 「患者番号が見つかりません」

**原因**:
- ノーザの患者番号と当アプリの患者IDが一致しない

**対処法**:
1. 患者マスタの同期を確認
2. 患者番号の形式を確認（先頭ゼロの有無等）
3. 新規患者の場合は先に患者登録を行う

### エラー2: 「日付の形式が不正です」

**原因**:
- 日付形式が想定外（例: `2025-01-11`ではなく`25/1/11`等）

**対処法**:
1. ノーザのCSV出力設定で日付形式を確認
2. `YYYY/MM/DD`形式に統一
3. Excelで開いて編集した場合は注意（自動変換される）

### エラー3: 「スタッフ名が見つかりません」

**原因**:
- 担当Drの名前が当アプリのスタッフ名と一致しない

**対処法**:
1. スタッフマスタを確認
2. 表記を統一（例: `佐藤花子` vs `佐藤`）
3. 見つからない場合でも売上データは登録される（担当者未割当）

### エラー4: 文字化け

**原因**:
- 文字エンコーディングの不一致

**対処法**:
1. インポート時にエンコーディングを`Shift-JIS`に変更
2. ノーザ側でUTF-8出力に変更（可能な場合）

---

## トラブルシューティング

### Q1: ノーザでCSV出力メニューが見つからない

**A**:
- バージョンが古い可能性があります（Ver.7.x以前）
- ノーザサポート（TEL: 0120-XXX-XXX）に問い合わせてアップデートを確認

### Q2: 自動エクスポートが動作しない

**A**:
1. Windowsタスクスケジューラで確認
2. ノーザが起動している必要はありません（サービスで動作）
3. 出力先フォルダの権限を確認

### Q3: 月次データが多すぎてエクスポートに時間がかかる

**A**:
- 週次または日次で分割してエクスポート
- 夜間の自動処理に切り替え
- データ量が多い場合は複数ファイルに分割

---

## サポート

### ノーザ オプテックのサポート
- 電話: 0120-XXX-XXX
- メール: support@noza.co.jp
- 営業時間: 平日 9:00-18:00

### 当アプリのサポート
- 設定 → ヘルプ → お問い合わせ
- メール: support@example.com

---

## 付録: CSVサンプルデータ

### サンプル1: 保険診療のみ
```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00001,山田太郎,2025/01/11,1,1500,15000,4500,0,4500,1,佐藤,初診・う蝕処置,
```

### サンプル2: 自費診療のみ
```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00003,佐藤次郎,2025/01/11,9,0,0,0,80000,80000,2,佐藤,インプラント,自費診療
```

### サンプル3: 保険+自費の混合
```csv
患者番号,患者氏名,診療日,保険種別,保険点数,請求額,入金額,自費額,合計金額,入金方法,担当Dr,診療内容,備考
00004,鈴木一郎,2025/01/11,1,2000,20000,6000,30000,36000,2,田中,歯周治療+ホワイトニング,保険併用
```

---

## テンプレートダウンロード

当アプリから以下のテンプレートをダウンロードできます：

- **標準フォーマット**: `/templates/sales_import_template.csv`
- **ノーザ オプテック形式**: `/templates/sales_import_noza_template.csv`

設定 → テンプレート → 売上インポート からダウンロード可能
