# 新規患者での連携解除テスト手順

## 🎯 目的
初回連携時のみ `original_patient_data` を保存する修正が正しく動作しているか確認する

## ⚠️ 重要
**既存の患者データではテストしないでください**
既存の患者は `original_patient_data` に問診票の名前が入っているため、元に戻りません。

## ✅ テスト手順

### 1. 新規Web予約を作成
1. Web予約フォームを開く
2. 以下のデータで予約を作成:
   - 姓: テスト
   - 名: 太郎
   - 姓カナ: テスト
   - 名カナ: タロウ
   - その他必要な情報を入力

### 2. 問診票を作成
1. 問診票フォームを開く
2. **異なる名前**で問診票を作成:
   - 姓: 田中
   - 名: 花子
   - 姓カナ: タナカ
   - 名カナ: ハナコ
   - その他の情報を入力

### 3. メインカレンダーで連携
1. メインカレンダーを開く
2. 「テスト太郎」の予約をクリック
3. 予約編集モーダルで「本登録」ボタンをクリック
4. 問診票選択モーダルで作成した問診票を選択
5. **コンソールを確認**:
   ```
   ✅ 「初回連携: 連携前の患者データを保存:」と表示されること
   ❌ 「再連携: 既存のoriginal_patient_dataを維持します」は表示されないこと
   ```

### 4. 患者名の変更を確認
1. カレンダーで予約名が「田中 花子」に変わっていることを確認
2. 設定ページ > 患者一覧で「田中 花子」として登録されていることを確認

### 5. 連携解除
1. 設定ページ > 患者一覧 > 「田中 花子」をクリック
2. 問診票タブを開く
3. 「連携解除」ボタンをクリック
4. **コンソールを確認**:
   ```
   ✅ 「元の患者データを復元しました」と表示されること
   ✅ 復元データに「テスト太郎」が含まれていること
   ```

### 6. 復元確認
1. カレンダーに戻る（自動更新されるはず）
2. 予約名が「テスト 太郎」に戻っていることを確認
3. 設定ページ > 患者一覧で「テスト 太郎」として表示されていることを確認

## 📊 期待される結果

### 成功の場合:
- ✅ 初回連携: コンソールに "初回連携" メッセージ
- ✅ 連携後: 患者名が「田中 花子」
- ✅ 連携解除後: 患者名が「テスト 太郎」に復元

### 失敗の場合（既存患者でテストした場合）:
- ❌ 再連携: コンソールに "再連携" メッセージ
- ❌ 連携解除後: 患者名が元に戻らない（問診票の名前のまま）

## 🔍 デバッグ用スクリプト

### original_patient_dataを確認:
```bash
node check-original-data.mjs
```

### 特定患者のデータを確認:
```bash
# check-patient-data.mjs を患者IDで実行
```

## 📝 注意事項

1. **必ず新規患者でテストすること**
2. コンソールログを必ず確認すること
3. ブラウザのキャッシュをクリアしてからテストすること
4. デプロイが完了していることを確認すること
